<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é•·è·‘æ¯”è³½ç´€éŒ„ - v1.5.2 (ä¿®æ­£ç‰ˆ)</title>
  <style>
    :root {
      --primary: #667eea;
      --bg: #f0f2f5;
      --text: #333;
      --border: #ccc;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; background:var(--bg); padding:20px; color: var(--text); }
    
    /* --- LANDING PAGE STYLES --- */
    #landingPage {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 80vh; text-align: center; max-width: 600px; margin: 0 auto;
    }
    .landing-card {
      background: #fff; padding: 40px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 100%;
    }
    .landing-title { font-size: 2.5em; margin-bottom: 10px; color: var(--primary); }
    .landing-desc { color: #666; margin-bottom: 30px; line-height: 1.6; }
    
    .landing-btn {
      display: block; width: 100%; padding: 15px; margin-bottom: 15px;
      border: 1px solid #ddd; border-radius: 8px; background: #fff;
      font-size: 1.1em; cursor: pointer; transition: 0.2s; text-align: left;
      display: flex; align-items: center; gap: 15px;
    }
    .landing-btn:hover { background: #f8f9fa; border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .landing-btn.primary { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border: none; }
    .landing-btn.primary:hover { opacity: 0.9; }
    
    .icon-box { font-size: 1.5em; width: 40px; text-align: center; }
    .btn-text h4 { margin: 0; font-size: 1em; }
    .btn-text p { margin: 2px 0 0; font-size: 0.8em; opacity: 0.8; }
    
    .demo-link { margin-top: 20px; font-size: 0.9em; color: #666; border-top: 1px solid #eee; padding-top: 15px; }
    .demo-link a { color: var(--primary); text-decoration: none; font-weight: bold; }
    .demo-link a:hover { text-decoration: underline; }

    /* --- MAIN APP STYLES --- */
    #mainApp { display: none; }

    .container { max-width: 1800px; margin:0 auto; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.1); min-height: 80vh; position: relative;}
    header { background:linear-gradient(135deg, var(--primary), #764ba2); color:#fff; padding:20px; text-align:center; border-radius: 12px 12px 0 0; }
    header h1 { font-size:1.8em; margin-bottom:5px; }
    
    .controls { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #e5e5e5; display: flex; flex-direction: column; gap: 12px; }
    .control-row-top input { width: 100%; padding:10px; border-radius:6px; border:1px solid var(--border); font-size:1em; }
    .control-row-filters { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    
    .filter-select { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: #fff; flex: 1; min-width: 100px; }
    #runnerFilter { flex: 1.5; min-width: 120px; }
    
    button { cursor: pointer; border: none; border-radius: 6px; font-size: 0.95em; transition: 0.2s; }
    .view-mode-group { display: flex; background: #e9ecef; padding: 2px; border-radius: 6px; flex-shrink: 0; }
    .view-mode-btn { padding: 6px 12px; background: transparent; color: #666; }
    .view-mode-btn.active { background: #fff; color: var(--primary); font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    
    .add-btn { 
      padding: 8px 16px; background: #28a745; color: #fff; font-weight: bold; 
      flex-shrink: 0; white-space: nowrap; z-index: 5;
      display: flex; align-items: center; justify-content: center;
    }
    .add-btn:hover { background: #218838; }
    
    .settings-container { position: relative; margin-left: auto; flex-shrink: 0; }
    .settings-btn { background: #fff; border: 1px solid var(--border); width: 40px; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; }
    .settings-menu { display: none; position: absolute; top: 100%; right: 0; width: 220px; background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); z-index: 100; padding: 5px 0; margin-top: 5px; }
    .settings-menu.show { display: block; }
    .menu-item { display: block; width: 100%; padding: 10px 15px; text-align: left; background: transparent; color: #333; }
    .menu-item:hover { background: #f8f9fa; color: var(--primary); }
    .menu-divider { border-top: 1px solid #eee; margin: 4px 0; }
    .menu-item.cloud-item { color: #667eea; font-weight: bold; background: #f0f4ff; }

    .table-wrapper { padding:15px 20px 20px; overflow-x:auto; min-height: 400px; }
    table { border-collapse:collapse; width:100%; font-size:0.9em; min-width: 800px; }
    thead th { position:sticky; top:0; background:var(--primary); color:#fff; padding:10px 8px; white-space:nowrap; z-index:1; text-align: left; cursor: pointer; }
    tbody td { padding:8px 8px; border-bottom:1px solid #eee; vertical-align: middle; }
    tbody tr:nth-child(even) { background:#fafafa; }
    tbody tr:hover { background:#f1f3f5; }
    
    .distance-tag { display:inline-block; padding:3px 8px; border-radius:12px; background:#e0e7ff; color:#4c51bf; font-size:0.85em; font-weight: bold;}
    .action-btn { padding:4px 8px; background:#0d6efd; color:#fff; border-radius: 4px; }
    .note-cell { color: #666; font-size: 0.9em; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .empty-cell { background:#fff3cd !important; }
    .date-cell { white-space:nowrap; font-family: monospace; }
    .sort-indicator { margin-left:4px; font-size: 0.8em; }

    /* Modal */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; backdrop-filter: blur(2px); }
    .modal.show { display:flex; align-items: center; justify-content: center; }
    .modal-content { background:#fff; width:95%; max-width:900px; padding:25px; border-radius:12px; max-height:90vh; overflow-y:auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .modal-header h2 { font-size:1.4em; color: #333; }
    .close-btn { font-size:2em; line-height: 1; color: #999; background: none; }
    
    .edit-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .field-full-mobile { grid-column: span 1; }
    .compact-zone {
      grid-column: span 2; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px;
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; align-items: end;
    }
    .form-group { margin-bottom: 5px; }
    .form-group label { font-size:0.85em; font-weight:bold; color: #555; margin-bottom:4px; display:block; }
    .form-group input, .form-group select, .form-group textarea { 
      width:100%; padding:8px 10px; border-radius:6px; border:1px solid #ccc; font-size:0.95em; font-family: inherit;
    }
    .form-group textarea { resize: vertical; min-height: 38px; }
    .form-group input[type="date"] { padding: 7px 10px; height: 38px; }
    .input-group { display: flex; gap: 0; }
    .input-group select { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; background: #eee; width: 35%; min-width: 80px; height: 38px; }
    .input-group input { border-top-left-radius: 0; border-bottom-left-radius: 0; flex: 1; height: 38px; }
    .time-split-group { display: flex; align-items: center; gap: 4px; }
    .time-split-group input { text-align: center; padding: 8px 2px; height: 38px; }
    .time-split-group input#f_finish_h { flex: 1.5; min-width: 65px; } 
    .time-split-group input#f_finish_m, .time-split-group input#f_finish_s { flex: 1; }
    .time-colon { font-weight: bold; color: #888; }
    .modal-buttons { margin-top:20px; display:flex; justify-content:flex-end; gap:10px; padding-top: 15px; border-top: 1px solid #eee; }
    .modal-buttons button { padding: 10px 20px; font-size: 1em; }
    .secondary { background:#6c757d; color:#fff; }
    .delete-btn { background:#dc3545; color:#fff; margin-right: auto; }
    .success { background:#28a745; color:#fff; }

    /* Footer & Copyright Styles (Modified) */
    .footer { padding:10px 20px 15px; background:#f8f9fa; font-size:0.8em; color:#666; border-top:1px solid #e5e5e5; margin-top: auto;}
    .copyright { 
      margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ddd; 
      text-align: center; color: #bbb; font-size: 0.85em; font-weight: 300; letter-spacing: 1px; font-style: italic;
    }

    /* Cloud Modal */
    .setup-guide { background: #fff8e1; border: 1px solid #ffe0b2; border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 0.9em; }
    .setup-guide h4 { margin-top: 0; margin-bottom: 10px; color: #e65100; display: flex; align-items: center; gap: 5px; }
    .setup-guide ol { padding-left: 20px; margin: 0; color: #333; line-height: 1.6; }
    .setup-guide li { margin-bottom: 8px; }
    
    .code-box { position: relative; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
    .code-box textarea { width: 100%; height: 100px; padding: 10px; font-family: monospace; font-size: 0.85em; border: none; background: #fafafa; color: #333; resize: vertical; }
    .copy-code-btn { position: absolute; top: 5px; right: 5px; padding: 4px 8px; background: #667eea; color: #fff; border: none; border-radius: 4px; font-size: 0.8em; cursor: pointer; opacity: 0.9; }
    .copy-code-btn:hover { opacity: 1; }

    .cloud-input-section { margin-bottom: 15px; border-top: 1px solid #eee; padding-top: 15px; }
    .cloud-status { padding: 10px; border-radius: 6px; background: #f1f3f5; margin-top: 10px; font-size: 0.9em; word-break: break-all; }
    .cloud-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .cloud-btn { padding: 15px; border: 1px solid #ccc; border-radius: 8px; background: #fff; text-align: center; cursor: pointer; transition: 0.2s; }
    .cloud-btn:hover { background: #f8f9fa; border-color: #999; }
    .cloud-btn h3 { margin-bottom: 5px; color: var(--primary); font-size: 1.1em; }
    .cloud-btn p { font-size: 0.85em; color: #666; margin: 0; }
    
    @media (max-width: 768px) {
      body { padding: 20px 10px; }
      .container { border-radius: 0; min-height: 100vh; }
      .controls { gap: 10px; }
      .filter-select { min-width: 45%; }
      #runnerFilter { min-width: 100%; order: -1; } 
      .modal-content { width: 100%; height: 100%; max-height: 100vh; border-radius: 0; padding: 15px; }
      .edit-grid { grid-template-columns: 1fr; gap: 12px; }
      .field-full-mobile { grid-column: 1 / -1; }
      .compact-zone { grid-column: 1 / -1; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
      .compact-full-mobile { grid-column: span 2; }
      .cloud-actions { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <div id="landingPage">
    <div class="landing-card">
      <div class="landing-title">ğŸƒâ€â™‚ï¸ é•·è·‘ç´€éŒ„</div>
      <p class="landing-desc">
        è¼•é¬†ç®¡ç†æ‚¨çš„é¦¬æ‹‰æ¾ã€åŠé¦¬åŠå„é¡é•·è·‘è³½äº‹ç´€éŒ„ã€‚<br>
        æ”¯æ´ CSV åŒ¯å…¥åŒ¯å‡ºã€å¤šç¶­åº¦ç¯©é¸èˆ‡é›²ç«¯å‚™ä»½ã€‚
      </p>

      <button class="landing-btn primary" onclick="loadDemoFromUrl()">
        <div class="icon-box">ğŸš€</div>
        <div class="btn-text">
          <h4>ä»¥ DEMO æª”ä½œç¤ºç¯„</h4>
          <p>è¼‰å…¥ç¯„ä¾‹è³‡æ–™ï¼Œå¿«é€Ÿé«”é©—åŠŸèƒ½</p>
        </div>
      </button>

      <button class="landing-btn" onclick="triggerLandingImport()">
        <div class="icon-box">ğŸ“‚</div>
        <div class="btn-text">
          <h4>åŒ¯å…¥ç¾æœ‰æª”æ¡ˆ</h4>
          <p>é¸æ“‡ .json æˆ– .csv æª”æ¡ˆ</p>
        </div>
      </button>

      <button class="landing-btn" onclick="enterAppEmpty()">
        <div class="icon-box">ğŸ“„</div>
        <div class="btn-text">
          <h4>ç©ºç™½é–‹å§‹</h4>
          <p>å»ºç«‹å…¨æ–°çš„ç´€éŒ„è¡¨</p>
        </div>
      </button>

      <div class="demo-link">
        éœ€è¦ç¯„ä¾‹æª”ï¼Ÿ <a href="https://fungccc.github.io/running-race-log/demo/demo_rrlog.csv" download>é»æ­¤ä¸‹è¼‰ Demo CSV</a>
      </div>
      
      <div class="copyright" style="margin-top: 30px; border-top: none;">è±ç‹‚å‡ºå“ â€¢ ç´€éŒ„æ¯ä¸€æ­¥</div>
    </div>
  </div>

  <div id="mainApp">
    <div class="container">
      <header>
        <h1>ğŸƒâ€â™‚ï¸ é•·è·‘æ¯”è³½ç´€éŒ„</h1>
        <p>v1.5.2 (ä¿®æ­£ç‰ˆ)</p>
      </header>

      <div class="controls">
        <div class="control-row-top">
          <input id="searchInput" type="text" placeholder="ğŸ” æœå°‹æ¯”è³½åç¨±ã€åœ°é»æˆ–ç·¨è™Ÿ..." oninput="applyFilters()">
        </div>

        <div class="control-row-filters">
          <select id="runnerFilter" class="filter-select" onchange="applyFilters()">
            <option value="">ğŸ‘¤ åƒè³½è€…(å…¨éƒ¨)</option>
          </select>
          <select id="distanceFilter" class="filter-select" onchange="applyFilters()">
            <option value="">ğŸ“ è·é›¢(å…¨éƒ¨)</option>
            <option value="10">10km</option>
            <option value="21">åŠé¦¬ (21km)</option>
            <option value="42">å…¨é¦¬ (42km)</option>
            <option value="OTHER">å…¶ä»–</option>
          </select>
          <select id="yearFilter" class="filter-select" onchange="applyFilters()">
            <option value="">ğŸ“… å¹´ä»½(å…¨éƒ¨)</option>
          </select>
          <select id="monthFilter" class="filter-select" onchange="applyFilters()">
            <option value="">ğŸŒ™ æœˆä»½(å…¨éƒ¨)</option>
            <option value="01">1æœˆ</option>
            <option value="02">2æœˆ</option>
            <option value="03">3æœˆ</option>
            <option value="04">4æœˆ</option>
            <option value="05">5æœˆ</option>
            <option value="06">6æœˆ</option>
            <option value="07">7æœˆ</option>
            <option value="08">8æœˆ</option>
            <option value="09">9æœˆ</option>
            <option value="10">10æœˆ</option>
            <option value="11">11æœˆ</option>
            <option value="12">12æœˆ</option>
          </select>

          <div class="view-mode-group">
            <button class="view-mode-btn active" id="btnModeSimple" onclick="setMode('simple')">ç²¾ç°¡</button>
            <button class="view-mode-btn" id="btnModeDetail" onclick="setMode('detail')">è©³ç´°</button>
          </div>
          
          <button class="add-btn" onclick="openAddModal()">ï¼‹ æ–°å¢</button>
          
          <div class="settings-container">
            <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
            <div id="settingsMenu" class="settings-menu">
              <button class="menu-item cloud-item" onclick="openCloudModal()">â˜ï¸ è¨­å®šé›²ç«¯é€£çµ</button>
              <div class="menu-divider"></div>
              <div class="menu-item" style="font-size:0.8em; color:#999; font-weight:bold;">æœ¬æ©Ÿæª”æ¡ˆæ“ä½œ</div>
              <button class="menu-item" onclick="triggerImportJson()">ğŸ“‚ åŒ¯å…¥ JSON</button>
              <button class="menu-item" onclick="downloadJSON()">ğŸ’¾ åŒ¯å‡º JSON</button>
              <div class="menu-divider"></div>
              <button class="menu-item" onclick="triggerImportCsv()">ğŸ“„ åŒ¯å…¥ CSV</button>
              <button class="menu-item" onclick="downloadCSV()">ğŸ“Š åŒ¯å‡º CSV</button>
              <div class="menu-divider"></div>
              <button class="menu-item" onclick="resetFilters()">ğŸ”„ é‡ç½®æ‰€æœ‰ç¯©é¸</button>
              <div class="menu-divider"></div>
              <button class="menu-item" onclick="showLanding()">ğŸ  è¿”å›é¦–é </button>
            </div>
          </div>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="raceTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
        <div id="noResults" class="no-results" style="display:none; text-align:center; padding:30px; color:#777;">
          æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ¯”è³½è³‡æ–™ã€‚
        </div>
      </div>

      <div class="footer">
        ğŸ’¡ æç¤ºï¼šè¨­å®š Google Sheet é€£çµå¾Œï¼Œå³å¯åœ¨ä¸åŒè£ç½®é–“åŒæ­¥è³‡æ–™ã€‚
        <div class="copyright">è±ç‹‚å‡ºå“ â€¢ ç´€éŒ„æ¯ä¸€æ­¥</div>
      </div>
    </div>
  </div>

  <input id="importJsonFile" type="file" accept=".json,application/json" style="display:none" onchange="importJSON(this.files[0])">
  <input id="importCsvFile" type="file" accept=".csv,text/csv" style="display:none" onchange="importCSV(this.files[0])">
  <input id="landingImportFile" type="file" accept=".json,.csv,application/json,text/csv" style="display:none" onchange="handleLandingImport(this.files[0])">

  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">ç·¨è¼¯æ¯”è³½è¨˜éŒ„</h2>
        <button class="close-btn" onclick="closeEditModal()">Ã—</button>
      </div>
      <input id="f_ç·¨è™Ÿ" type="hidden">
      <div class="edit-grid">
        <div class="form-group field-full-mobile">
          <label>æ¯”è³½åç¨±</label>
          <input id="f_æ¯”è³½åç¨±" type="text" list="list-cn-name" placeholder="ä¾‹å¦‚ï¼š2024 è‡ºåŒ—é¦¬æ‹‰æ¾">
          <datalist id="list-cn-name"></datalist>
        </div>
        <div class="form-group field-full-mobile">
          <label>Race Name</label>
          <textarea id="f_RaceName" rows="2" placeholder="e.g. ASICS Hong Kong Half-Marathon Championship 2025"></textarea>
          <datalist id="list-en-name"></datalist>
        </div>
        <div class="form-group">
          <label>æ¯”è³½æ—¥æœŸ</label>
          <input id="f_æ¯”è³½æ—¥æœŸ" type="date">
        </div>
        <div class="form-group">
          <label>åœ°é»</label>
          <input id="f_åœ°é»" type="text" list="list-location">
          <datalist id="list-location"></datalist>
        </div>
        <div class="form-group">
          <label>ä¸»è¾¦å–®ä½</label>
          <input id="f_ä¸»è¾¦å–®ä½" type="text" list="list-org">
          <datalist id="list-org"></datalist>
        </div>
        <div class="form-group">
          <label>è³½äº‹çµ„åˆ¥</label>
          <input id="f_è³½äº‹çµ„åˆ¥" type="text" list="list-category" placeholder="å…¨é¦¬çµ„ / å…¬é–‹çµ„">
          <datalist id="list-category"></datalist>
        </div>
        <div class="form-group">
          <label>åƒè³½è€…</label>
          <div style="position:relative;">
             <select id="f_åƒè³½è€…_select" onchange="handleRunnerChange(this)"></select>
             <input id="f_åƒè³½è€…_input" type="text" style="display:none; margin-top:5px;" placeholder="è¼¸å…¥æ–°åƒè³½è€…å§“å">
          </div>
        </div>
         <div class="form-group">
          <label>å‚™è¨»</label>
          <div style="position:relative;">
             <select id="f_å‚™è¨»_select" onchange="handleNoteChange(this)">
                <option value="">(ç„¡)</option>
                <option value="PB">PB (å€‹äººæœ€ä½³)</option>
                <option value="æŠ½ç­‹">æŠ½ç­‹</option>
                <option value="å¤©æ°£ç†±">å¤©æ°£ç†±</option>
                <option value="è½é›¨">è½é›¨</option>
                <option value="é †åˆ©å®Œè³½">é †åˆ©å®Œè³½</option>
                <option value="custom">â• è‡ªè¨‚...</option>
             </select>
             <input id="f_å‚™è¨»_input" type="text" style="display:none; margin-top:5px;" placeholder="è¼¸å…¥å‚™è¨»å…§å®¹">
          </div>
        </div>
        <div class="compact-zone">
          <div class="form-group compact-full-mobile">
            <label>è·é›¢</label>
            <div style="position:relative;">
              <select id="f_è·é›¢_select" onchange="handleDistanceChange(this)">
                <option value="10 km">10 km</option>
                <option value="21.0975 km">21.0975 km (åŠé¦¬)</option>
                <option value="42.195 km">42.195 km (å…¨é¦¬)</option>
                <option value="custom">â• æ–°å¢å…¶ä»–è·é›¢...</option>
              </select>
              <input id="f_è·é›¢_input" type="text" style="display:none; margin-top:5px;" placeholder="è¼¸å…¥è·é›¢ (å¦‚ 5 km)">
            </div>
          </div>
          <div class="form-group compact-full-mobile">
            <label>è²»ç”¨</label>
            <div class="input-group">
              <select id="f_è²»ç”¨_å¹£ç¨®">
                <option value="æ¸¯å…ƒ$">æ¸¯å…ƒ$</option>
                <option value="ç¾å…ƒ$">ç¾å…ƒ$</option>
                <option value="æ—¥åœ“Â¥">æ—¥åœ“Â¥</option>
                <option value="è‹±éŠÂ£">è‹±éŠÂ£</option>
                <option value="æ­å…ƒâ‚¬">æ­å…ƒâ‚¬</option>
                <option value="æ¾³å¹£A$">æ¾³å¹£A$</option>
                <option value="">å…¶ä»–</option>
              </select>
              <input id="f_è²»ç”¨_é‡‘é¡" type="number" placeholder="é‡‘é¡">
            </div>
          </div>
          <div class="form-group compact-full-mobile">
            <label>èµ·æ­¥æ™‚é–“</label>
            <input id="f_èµ·æ­¥æ™‚é–“" type="time">
          </div>
          <div class="form-group compact-full-mobile">
            <label>å®Œæˆæ™‚é–“ (æ™‚:åˆ†:ç§’)</label>
            <div class="time-split-group">
              <input id="f_finish_h" type="number" min="0" max="999" placeholder="hh">
              <span class="time-colon">:</span>
              <input id="f_finish_m" type="number" min="0" max="59" placeholder="mm">
              <span class="time-colon">:</span>
              <input id="f_finish_s" type="number" min="0" max="59" placeholder="ss">
            </div>
          </div>
          <div class="form-group">
            <label>åƒè³½ç·¨è™Ÿ</label>
            <input id="f_åƒè³½ç·¨è™Ÿ" type="text">
          </div>
          <div class="form-group">
            <label>æº«åº¦(Â°C)</label>
            <input id="f_æº«åº¦" type="number" step="0.1">
          </div>
          <div class="form-group">
            <label>çµ„åˆ¥åæ¬¡</label>
            <input id="f_çµ„åˆ¥åæ¬¡" type="number">
          </div>
          <div class="form-group">
            <label>ç¸½åæ¬¡</label>
            <input id="f_ç¸½åæ¬¡" type="number">
          </div>
        </div>
      </div>
      <div class="modal-buttons">
        <button class="delete-btn" id="deleteBtn" onclick="deleteRace()">åˆªé™¤æ­¤ç´€éŒ„</button>
        <button class="secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
        <button class="success" onclick="saveRace()">ğŸ’¾ ä¿å­˜è®Šæ›´</button>
      </div>
    </div>
  </div>

  <div id="cloudModal" class="modal">
    <div class="modal-content" style="max-width: 650px;">
      <div class="modal-header">
        <h2>â˜ï¸ é›²ç«¯åŒæ­¥è¨­å®š (Google Sheets)</h2>
        <button class="close-btn" onclick="closeCloudModal()">Ã—</button>
      </div>
      
      <div class="setup-guide">
        <h4>âš™ï¸ Google ç«¯è¨­å®šæ•™å­¸ (åƒ…éœ€ä¸€æ¬¡)</h4>
        <ol>
          <li>åˆ° Google Sheets å»ºç«‹ç©ºç™½è©¦ç®—è¡¨ï¼Œé»æ“Šä¸Šæ–¹ <b>æ“´å……åŠŸèƒ½ > Apps Script</b>ã€‚</li>
          <li>æ¸…é™¤ç·¨è¼¯å™¨å…§å®¹ï¼Œé»æ“Šå³æ–¹æŒ‰éˆ•è¤‡è£½ä»£ç¢¼ä¸¦è²¼ä¸Šï¼š
            <div class="code-box">
              <button class="copy-code-btn" onclick="copyGasCode()">ğŸ“‹ è¤‡è£½ä»£ç¢¼</button>
              <textarea id="gasCodeSource" readonly>
function doGet(e){return handleRequest(e);}
function doPost(e){return handleRequest(e);}
function handleRequest(e){
 var lock=LockService.getScriptLock();lock.tryLock(10000);
 try{
  var sheet=SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  if(e.postData){
   var data=JSON.parse(e.postData.contents);
   if(!Array.isArray(data)||data.length===0) return responseJSON({status:'error',message:'ç„¡æ•ˆ'});
   var headers=Object.keys(data[0]);
   sheet.clear();
   sheet.getRange(1,1,1,headers.length).setValues([headers]);
   var rows=data.map(function(r){return headers.map(function(k){return r[k]||"";});});
   if(rows.length>0) sheet.getRange(2,1,rows.length,headers.length).setValues(rows);
   return responseJSON({status:'success',message:'å‚™ä»½æˆåŠŸ'});
  }else{
   var rows=sheet.getDataRange().getValues();
   if(rows.length<2) return responseJSON([]);
   var headers=rows.shift();
   var result=rows.map(function(r){var o={};headers.forEach(function(h,i){o[h]=String(r[i]);});return o;});
   return responseJSON(result);
  }
 }catch(e){return responseJSON({status:'error',message:String(e)});}
 finally{lock.releaseLock();}
}
function responseJSON(d){return ContentService.createTextOutput(JSON.stringify(d)).setMimeType(ContentService.MimeType.JSON);}
              </textarea>
            </div>
          </li>
          <li>é»æ“Š <b>éƒ¨ç½² > æ–°å¢éƒ¨ç½² > ç¶²é æ‡‰ç”¨ç¨‹å¼</b>ã€‚</li>
          <li>è¨­å®šï¼šåŸ·è¡Œèº«åˆ†=<b>æˆ‘</b>ï¼Œèª°å¯ä»¥å­˜å–=<b>æ‰€æœ‰äºº</b> (é‡è¦!)ã€‚</li>
          <li>è¤‡è£½ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ã€ä¸¦è²¼åœ¨ä¸‹æ–¹æ¬„ä½ã€‚</li>
        </ol>
      </div>

      <div class="cloud-input-section">
        <div class="form-group">
          <label>Google Apps Script ç¶²å€ (Web App URL)</label>
          <input id="gasUrlInput" type="text" placeholder="https://script.google.com/macros/s/..../exec">
        </div>
        
        <div class="cloud-status" id="cloudStatus">
          ç‹€æ…‹ï¼šå°šæœªé€£çµã€‚è«‹è¼¸å…¥ç¶²å€ä¸¦é»æ“Šå„²å­˜ã€‚
        </div>

        <div class="modal-buttons" style="margin-top:10px;">
          <button class="secondary" onclick="closeCloudModal()">é—œé–‰</button>
          <button class="success" onclick="saveGasUrl()">ğŸ’¾ å„²å­˜ç¶²å€</button>
        </div>
      </div>

      <div class="cloud-actions">
        <div class="cloud-btn" onclick="syncCloud('backup')">
          <h3>â¬†ï¸ å‚™ä»½åˆ°é›²ç«¯</h3>
          <p>å°‡ç›®å‰çš„ç¶²é è³‡æ–™<br>è¦†è“‹åˆ° Google Sheet</p>
        </div>
        <div class="cloud-btn" onclick="syncCloud('restore')">
          <h3>â¬‡ï¸ å¾é›²ç«¯é‚„åŸ</h3>
          <p>å¾ Google Sheet ä¸‹è¼‰<br>ä¸¦è¦†è“‹ç›®å‰è³‡æ–™</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const ALL_FIELDS = ["ç·¨è™Ÿ", "æ¯”è³½åç¨±", "Race Name", "æ¯”è³½æ—¥æœŸ", "è·é›¢", "åœ°é»", "è²»ç”¨", "ä¸»è¾¦å–®ä½", "èµ·æ­¥æ™‚é–“", "è³½äº‹çµ„åˆ¥", "åƒè³½ç·¨è™Ÿ", "åƒè³½è€…", "æº«åº¦", "çµ„åˆ¥åæ¬¡", "ç¸½åæ¬¡", "å®Œæˆæ™‚é–“", "å‚™è¨»"];
    const COLUMNS_SIMPLE = ["ç·¨è™Ÿ", "æ¯”è³½æ—¥æœŸ", "æ¯”è³½åç¨±", "è·é›¢", "å®Œæˆæ™‚é–“", "å‚™è¨»"];
    const COLUMNS_DETAIL = ["ç·¨è™Ÿ", "æ¯”è³½æ—¥æœŸ", "æ¯”è³½åç¨±", "Race Name", "åœ°é»", "è·é›¢", "è²»ç”¨", "èµ·æ­¥æ™‚é–“", "å®Œæˆæ™‚é–“", "åƒè³½è€…", "è³½äº‹çµ„åˆ¥", "åƒè³½ç·¨è™Ÿ", "çµ„åˆ¥åæ¬¡", "ç¸½åæ¬¡", "æº«åº¦", "å‚™è¨»"];
    const DEMO_URL = "https://fungccc.github.io/running-race-log/demo/demo_rrlog.csv";

    let racesData = [];
    let filtered = [];
    let currentIndex = -1;
    let viewMode = 'simple';
    let sortField = "æ¯”è³½æ—¥æœŸ";
    let sortDir = "desc";

    document.addEventListener('DOMContentLoaded', () => {
        const savedUrl = localStorage.getItem('gasUrl');
        if(savedUrl) {
           document.getElementById('gasUrlInput').value = savedUrl;
           document.getElementById('cloudStatus').textContent = "âœ… å·²é€£çµï¼š " + savedUrl.substring(0, 30) + "...";
           document.getElementById('cloudStatus').style.color = "green";
        }
    });

    document.addEventListener('click', function(e) {
      const menu = document.getElementById('settingsMenu');
      const btn = document.querySelector('.settings-btn');
      if (!menu.contains(e.target) && !btn.contains(e.target)) { menu.classList.remove('show'); }
    });

    function showMainApp() {
        document.getElementById('landingPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        renderHeaders(); refreshData();
    }
    
    function showLanding() {
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('landingPage').style.display = 'flex';
        document.getElementById('settingsMenu').classList.remove('show');
    }

    function enterAppEmpty() {
        racesData = [];
        showMainApp();
    }

    function loadDemoFromUrl() {
        if(!confirm("ç¢ºå®šè¦è¼‰å…¥ Demo è³‡æ–™å—ï¼Ÿé€™å°‡æœƒè¦†è“‹æ‚¨ç›®å‰çš„æš«å­˜è³‡æ–™ã€‚")) return;
        fetch(DEMO_URL)
        .then(response => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.text();
        })
        .then(csvText => {
            parseCSVData(csvText);
            // Fix: Reset filters so data is visible
            document.getElementById("searchInput").value = "";
            document.getElementById("runnerFilter").value = "";
            document.getElementById("distanceFilter").value = "";
            document.getElementById("yearFilter").value = "";
            document.getElementById("monthFilter").value = "";
            alert("Demo è³‡æ–™è¼‰å…¥æˆåŠŸï¼");
            showMainApp();
        })
        .catch(error => {
            alert("è¼‰å…¥ Demo å¤±æ•—ï¼š" + error.message);
        });
    }
    
    function triggerLandingImport() { document.getElementById("landingImportFile").click(); }

    function handleLandingImport(file) {
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const content = e.target.result;
            if (file.name.endsWith('.json')) {
                try {
                    const data = JSON.parse(content);
                    if (Array.isArray(data)) { racesData = data; showMainApp(); }
                    else alert("JSON æ ¼å¼éŒ¯èª¤");
                } catch (err) { alert("JSON è§£æå¤±æ•—"); }
            } else {
                parseCSVData(content);
                showMainApp();
            }
        };
        reader.readAsText(file);
    }

    function toggleSettings() { document.getElementById('settingsMenu').classList.toggle('show'); }
    function setMode(mode) {
      viewMode = mode;
      document.getElementById('btnModeSimple').className = mode === 'simple' ? 'view-mode-btn active' : 'view-mode-btn';
      document.getElementById('btnModeDetail').className = mode === 'detail' ? 'view-mode-btn active' : 'view-mode-btn';
      renderHeaders(); renderTable(filtered);
    }

    function renderHeaders() {
      const thead = document.getElementById('tableHead');
      const columns = viewMode === 'simple' ? COLUMNS_SIMPLE : COLUMNS_DETAIL;
      let html = '<tr>';
      columns.forEach(col => {
        let sortMark = 'â†•';
        if (sortField === col) sortMark = sortDir === 'asc' ? 'â†‘' : 'â†“';
        html += `<th onclick="changeSort('${col}')">${col}<span class="sort-indicator">${sortMark}</span></th>`;
      });
      html += '<th>æ“ä½œ</th></tr>';
      thead.innerHTML = html;
    }

    function changeSort(field) {
      if (sortField === field) { sortDir = (sortDir === "asc") ? "desc" : "asc"; } 
      else { sortField = field; sortDir = (field === "æ¯”è³½æ—¥æœŸ") ? "desc" : "asc"; }
      renderHeaders(); applyFilters();
    }

    function refreshData() { populateYears(); refreshSuggestionLists(); applyFilters(); }

    function populateYears() {
      const yearSelect = document.getElementById('yearFilter');
      const currentVal = yearSelect.value;
      const years = new Set();
      racesData.forEach(r => { if (r["æ¯”è³½æ—¥æœŸ"] && r["æ¯”è³½æ—¥æœŸ"].length >= 4) years.add(r["æ¯”è³½æ—¥æœŸ"].substring(0, 4)); });
      const sortedYears = Array.from(years).sort().reverse();
      let html = '<option value="">ğŸ“… å¹´ä»½(å…¨éƒ¨)</option>';
      sortedYears.forEach(y => html += `<option value="${y}">${y}</option>`);
      yearSelect.innerHTML = html; yearSelect.value = currentVal;
    }

    function applyFilters() {
      const q = document.getElementById("searchInput").value.toLowerCase();
      const distFilter = document.getElementById("distanceFilter").value;
      const runnerFilter = document.getElementById("runnerFilter").value;
      const yearFilter = document.getElementById("yearFilter").value;
      const monthFilter = document.getElementById("monthFilter").value;

      filtered = racesData.filter(function(r) {
        const cn = (r["æ¯”è³½åç¨±"] || r["ä¸­æ–‡åç¨±"] || "").toLowerCase();
        const en = (r["Race Name"] || r["è‹±æ–‡åç¨±"] || "").toLowerCase();
        const loc = (r["åœ°é»"] || "").toLowerCase();
        const matchText = !q || cn.includes(q) || en.includes(q) || loc.includes(q);
        const distStr = r["è·é›¢"] || "";
        let matchDistance = true;
        if (distFilter === "OTHER") { matchDistance = !distStr || (!distStr.includes("10") && !distStr.includes("21") && !distStr.includes("42")); } 
        else if (distFilter) { matchDistance = distStr.includes(distFilter); }
        const matchRunner = !runnerFilter || (r["åƒè³½è€…"] || "").trim() === runnerFilter;
        const rDate = r["æ¯”è³½æ—¥æœŸ"] || "";
        const matchYear = !yearFilter || rDate.startsWith(yearFilter);
        let matchMonth = true;
        if (monthFilter && rDate.length >= 7) { matchMonth = rDate.split("-")[1] === monthFilter; }
        return matchText && matchDistance && matchRunner && matchYear && matchMonth;
      });

      filtered.sort(function(a, b) {
        let v1 = a[sortField]; let v2 = b[sortField];
        if (v1 == null) v1 = ""; if (v2 == null) v2 = "";
        let cmp = 0;
        if (sortField === "æ¯”è³½æ—¥æœŸ") { cmp = (!v1 && !v2) ? 0 : (!v1 ? 1 : (!v2 ? -1 : v1.localeCompare(v2))); } 
        else if (["ç·¨è™Ÿ", "æº«åº¦", "çµ„åˆ¥åæ¬¡", "ç¸½åæ¬¡"].includes(sortField)) { cmp = (parseFloat(v1)||0) - (parseFloat(v2)||0); } 
        else { cmp = String(v1).localeCompare(String(v2), "zh-Hant"); }
        return sortDir === "desc" ? -cmp : cmp;
      });
      renderTable(filtered);
    }

    function renderTable(list) {
      const tbody = document.getElementById("tableBody");
      const noRes = document.getElementById("noResults");
      if (!list.length) { tbody.innerHTML = ""; noRes.style.display = "block"; return; }
      noRes.style.display = "none";
      const columns = viewMode === 'simple' ? COLUMNS_SIMPLE : COLUMNS_DETAIL;
      const rowsHtml = list.map(function(r) {
        let rowHtml = '<tr>';
        columns.forEach(col => {
          let dataKey = col;
          if (col === "æ¯”è³½åç¨±" && !r[col]) dataKey = "ä¸­æ–‡åç¨±";
          if (col === "Race Name" && !r[col]) dataKey = "è‹±æ–‡åç¨±";
          const val = r[dataKey] || "";
          let displayVal = val; let extraClass = "";
          if (col === "è·é›¢" && val) displayVal = `<span class="distance-tag">${val}</span>`;
          else if (col === "æ¯”è³½æ—¥æœŸ") extraClass = "date-cell";
          else if (col === "å‚™è¨»") extraClass = "note-cell";
          else if (col === "å®Œæˆæ™‚é–“" && !val) extraClass = "empty-cell";
          rowHtml += `<td class="${!val && col !== 'å‚™è¨»' ? 'empty-cell ' : ''}${extraClass}">${displayVal}</td>`;
        });
        const id = r["ç·¨è™Ÿ"];
        rowHtml += `<td><button class="action-btn" onclick="openEditModal(${id})">ç·¨è¼¯</button></td></tr>`;
        return rowHtml;
      }).join("");
      tbody.innerHTML = rowsHtml;
    }

    // Modal Logic
    function handleDistanceChange(select) { const i = document.getElementById("f_è·é›¢_input"); if (select.value === "custom") { select.style.display = "none"; i.style.display = "block"; i.value = ""; i.focus(); } else { i.style.display = "none"; } }
    function handleRunnerChange(select) { const i = document.getElementById("f_åƒè³½è€…_input"); if (select.value === "custom") { select.style.display = "none"; i.style.display = "block"; i.value = ""; i.focus(); } else { i.style.display = "none"; } }
    function handleNoteChange(select) { const i = document.getElementById("f_å‚™è¨»_input"); if (select.value === "custom") { select.style.display = "none"; i.style.display = "block"; i.value = ""; i.focus(); } else { i.style.display = "none"; } }

    function openEditModal(id) {
      currentIndex = racesData.findIndex(r => r["ç·¨è™Ÿ"] === id);
      const r = currentIndex === -1 ? {} : racesData[currentIndex];
      const isEdit = currentIndex !== -1;
      document.getElementById("modalTitle").textContent = isEdit ? "ç·¨è¼¯æ¯”è³½è¨˜éŒ„" : "æ–°å¢æ¯”è³½è¨˜éŒ„";
      document.getElementById("deleteBtn").style.display = isEdit ? "block" : "none";
      if (!isEdit) { const maxId = racesData.length ? Math.max(...racesData.map(d => Number(d["ç·¨è™Ÿ"])||0)) : 0; document.getElementById("f_ç·¨è™Ÿ").value = maxId + 1; } 
      else { document.getElementById("f_ç·¨è™Ÿ").value = r["ç·¨è™Ÿ"]; }
      document.getElementById("f_æ¯”è³½åç¨±").value = r["æ¯”è³½åç¨±"] || r["ä¸­æ–‡åç¨±"] || "";
      document.getElementById("f_RaceName").value = r["Race Name"] || r["è‹±æ–‡åç¨±"] || "";
      ["æ¯”è³½æ—¥æœŸ", "åœ°é»", "ä¸»è¾¦å–®ä½", "è³½äº‹çµ„åˆ¥", "åƒè³½ç·¨è™Ÿ", "æº«åº¦", "çµ„åˆ¥åæ¬¡", "ç¸½åæ¬¡"].forEach(k => { document.getElementById("f_" + k).value = r[k] || ""; });

      const distVal = r["è·é›¢"] || ""; const ds = document.getElementById("f_è·é›¢_select"); const di = document.getElementById("f_è·é›¢_input");
      if (Array.from(ds.options).map(o=>o.value).includes(distVal) || !distVal) { ds.value = distVal||"10 km"; ds.style.display="block"; di.style.display="none"; }
      else { ds.value="custom"; ds.style.display="none"; di.style.display="block"; di.value=distVal; }

      const runVal = r["åƒè³½è€…"] || ""; const rs = document.getElementById("f_åƒè³½è€…_select"); const ri = document.getElementById("f_åƒè³½è€…_input");
      const unqRun = Array.from(new Set(racesData.map(d => (d["åƒè³½è€…"]||"").trim()).filter(Boolean))).sort();
      let rh = '<option value="custom">â• æ–°å¢åƒè³½è€…...</option>'; unqRun.forEach(rn => { rh += `<option value="${rn}">${rn}</option>`; }); rs.innerHTML = rh;
      if (unqRun.includes(runVal) || (!runVal && unqRun.length>0)) { rs.value = runVal||unqRun[0]; rs.style.display="block"; ri.style.display="none"; }
      else { rs.value="custom"; rs.style.display="none"; ri.style.display="block"; ri.value=runVal; }

      const nVal = r["å‚™è¨»"] || ""; const ns = document.getElementById("f_å‚™è¨»_select"); const ni = document.getElementById("f_å‚™è¨»_input");
      if (Array.from(ns.options).map(o=>o.value).includes(nVal) || !nVal) { ns.value = nVal; ns.style.display="block"; ni.style.display="none"; }
      else { ns.value="custom"; ns.style.display="none"; ni.style.display="block"; ni.value=nVal; }

      const feeStr = r["è²»ç”¨"] || ""; const cm = ["æ¸¯å…ƒ$", "ç¾å…ƒ$", "æ—¥åœ“Â¥", "è‹±éŠÂ£", "æ­å…ƒâ‚¬", "æ¾³å¹£A$"]; let fc = "", fa = feeStr;
      for (let c of cm) { if (feeStr.startsWith(c)) { fc = c; fa = feeStr.replace(c, "").trim(); break; } }
      document.getElementById("f_è²»ç”¨_å¹£ç¨®").value = fc; document.getElementById("f_è²»ç”¨_é‡‘é¡").value = fa;

      document.getElementById("f_èµ·æ­¥æ™‚é–“").value = r["èµ·æ­¥æ™‚é–“"] || "";
      const ft = (r["å®Œæˆæ™‚é–“"]||"").split(":");
      document.getElementById("f_finish_h").value = ft[0]||""; document.getElementById("f_finish_m").value = ft[1]||""; document.getElementById("f_finish_s").value = ft[2]||"";
      document.getElementById("editModal").classList.add("show");
    }

    function closeEditModal() { document.getElementById("editModal").classList.remove("show"); }
    function openAddModal() { openEditModal(-1); }

    function saveRace() {
      const rec = {};
      rec["ç·¨è™Ÿ"] = parseInt(document.getElementById("f_ç·¨è™Ÿ").value, 10);
      rec["æ¯”è³½åç¨±"] = document.getElementById("f_æ¯”è³½åç¨±").value.trim(); rec["Race Name"] = document.getElementById("f_RaceName").value.trim();
      rec["ä¸­æ–‡åç¨±"] = rec["æ¯”è³½åç¨±"]; rec["è‹±æ–‡åç¨±"] = rec["Race Name"];
      ["æ¯”è³½æ—¥æœŸ", "åœ°é»", "ä¸»è¾¦å–®ä½", "è³½äº‹çµ„åˆ¥", "åƒè³½ç·¨è™Ÿ", "æº«åº¦", "çµ„åˆ¥åæ¬¡", "ç¸½åæ¬¡"].forEach(k => { rec[k] = document.getElementById("f_" + k).value.trim(); });
      
      const ds = document.getElementById("f_è·é›¢_select"); rec["è·é›¢"] = (ds.value === "custom") ? document.getElementById("f_è·é›¢_input").value.trim() : ds.value;
      const rs = document.getElementById("f_åƒè³½è€…_select"); rec["åƒè³½è€…"] = (rs.value === "custom") ? document.getElementById("f_åƒè³½è€…_input").value.trim() : rs.value;
      const ns = document.getElementById("f_å‚™è¨»_select"); rec["å‚™è¨»"] = (ns.value === "custom") ? document.getElementById("f_å‚™è¨»_input").value.trim() : ns.value;
      
      const curr = document.getElementById("f_è²»ç”¨_å¹£ç¨®").value; const amt = document.getElementById("f_è²»ç”¨_é‡‘é¡").value.trim(); rec["è²»ç”¨"] = (curr && amt) ? curr + amt : (amt || "");
      rec["èµ·æ­¥æ™‚é–“"] = document.getElementById("f_èµ·æ­¥æ™‚é–“").value;
      const h = document.getElementById("f_finish_h").value.trim(), m = document.getElementById("f_finish_m").value.trim(), s = document.getElementById("f_finish_s").value.trim();
      rec["å®Œæˆæ™‚é–“"] = (h||m||s) ? `${h}:${(m||0).toString().padStart(2,'0')}:${(s||0).toString().padStart(2,'0')}` : "";

      if (!rec["æ¯”è³½åç¨±"] && !rec["Race Name"]) { alert("è«‹è‡³å°‘è¼¸å…¥æ¯”è³½åç¨±ã€‚"); return; }
      if (currentIndex === -1) { racesData.push(rec); } else { racesData[currentIndex] = rec; }
      refreshData(); closeEditModal();
    }

    function deleteRace() { if (currentIndex === -1 || !confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return; racesData.splice(currentIndex, 1); refreshData(); closeEditModal(); }
    
    function refreshSuggestionLists() {
      updateDatalist("list-cn-name", ["æ¯”è³½åç¨±", "ä¸­æ–‡åç¨±"]); updateDatalist("list-en-name", ["Race Name", "è‹±æ–‡åç¨±"]);
      updateDatalist("list-location", ["åœ°é»"]); updateDatalist("list-org", ["ä¸»è¾¦å–®ä½"]); updateDatalist("list-category", ["è³½äº‹çµ„åˆ¥"]);
    }
    function updateDatalist(id, keys) {
      const dl = document.getElementById(id); if (!dl) return;
      const vals = new Set(); racesData.forEach(r => { keys.forEach(k => { if(r[k]) vals.add(r[k].trim()); }); });
      dl.innerHTML = Array.from(vals).sort().map(v => `<option value="${v.replace(/"/g, "&quot;")}"></option>`).join("");
    }
    function resetFilters() {
      document.getElementById("searchInput").value = ""; document.getElementById("runnerFilter").value = "";
      document.getElementById("distanceFilter").value = ""; document.getElementById("yearFilter").value = ""; document.getElementById("monthFilter").value = "";
      applyFilters();
    }

    function triggerImportJson() { document.getElementById("importJsonFile").click(); document.getElementById('settingsMenu').classList.remove('show'); }
    function triggerImportCsv() { document.getElementById("importCsvFile").click(); document.getElementById('settingsMenu').classList.remove('show'); }
    
    function downloadJSON() {
       document.getElementById('settingsMenu').classList.remove('show'); if (!racesData.length) { alert("ç„¡è³‡æ–™"); return; }
       const blob = new Blob([JSON.stringify(racesData, null, 2)], {type: "application/json"});
       const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "Running-Data-" + new Date().toISOString().slice(0,10) + ".json"; a.click();
    }
    function downloadCSV() {
      document.getElementById('settingsMenu').classList.remove('show'); if (!racesData.length) { alert("ç„¡è³‡æ–™"); return; }
      const rows = racesData.map(r => ALL_FIELDS.map(k => { let val = r[k] || ""; if (k === "æ¯”è³½åç¨±" && !val) val = r["ä¸­æ–‡åç¨±"] || ""; if (k === "Race Name" && !val) val = r["è‹±æ–‡åç¨±"] || ""; return `"${String(val).replace(/"/g, '""')}"`; }).join(",")).join("\r\n");
      const blob = new Blob([ALL_FIELDS.join(",") + "\r\n" + rows], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "Running-Data.csv"; a.click();
    }
    
    function importJSON(file) {
      if (!file) return; const reader = new FileReader();
      reader.onload = e => { try { const data = JSON.parse(e.target.result); if (Array.isArray(data)) { racesData = data; refreshData(); alert("åŒ¯å…¥æˆåŠŸ"); } } catch(err) { alert("JSON æ ¼å¼éŒ¯èª¤"); } };
      reader.readAsText(file);
    }
    
    function parseCSVData(text) {
       // FIX: Remove BOM if present (Crucial for Excel/GitHub CSVs)
       if (text.charCodeAt(0) === 0xFEFF) { text = text.slice(1); }

       const rows = []; let quote = false; let col = 0, row = 0;
       for (let i = 0; i < text.length; i++) {
           const c = text[i], nc = text[i+1]; rows[row] = rows[row] || []; rows[row][col] = rows[row][col] || "";
           if (c === '"' && quote && nc === '"') { rows[row][col] += '"'; ++i; continue; }
           if (c === '"') { quote = !quote; continue; }
           if (c === ',' && !quote) { ++col; continue; }
           if (c === '\r' && !quote && nc === '\n') { ++row; col = 0; ++i; continue; }
           if (c === '\n' && !quote) { ++row; col = 0; continue; }
           rows[row][col] += c;
       }
       if(rows.length > 0) {
           const headers = rows[0].map(h => h.trim());
           const newDat = [];
           for(let i=1; i<rows.length; i++) {
             if (rows[i].length < 2) continue; let obj = {}; ALL_FIELDS.forEach(f => obj[f] = "");
             rows[i].forEach((val, idx) => { if (headers[idx]) obj[headers[idx]] = val; });
             obj["ç·¨è™Ÿ"] = Number(obj["ç·¨è™Ÿ"]) || (i); newDat.push(obj);
           }
           racesData = newDat; refreshData();
       }
    }

    function importCSV(file) {
       const reader = new FileReader();
       reader.onload = e => {
         try { parseCSVData(e.target.result); alert("CSV åŒ¯å…¥æˆåŠŸ"); } catch(e) { alert("CSV è§£æéŒ¯èª¤"); }
       }; reader.readAsText(file);
    }

    function openCloudModal() { document.getElementById('settingsMenu').classList.remove('show'); document.getElementById('cloudModal').classList.add('show'); }
    function closeCloudModal() { document.getElementById('cloudModal').classList.remove('show'); }
    function copyGasCode() { const c = document.getElementById('gasCodeSource').value; navigator.clipboard.writeText(c).then(() => { alert("ä»£ç¢¼å·²è¤‡è£½"); }); }
    function saveGasUrl() {
        const u = document.getElementById('gasUrlInput').value.trim(); if(!u) { alert("ç¶²å€ä¸èƒ½ç‚ºç©º"); return; }
        localStorage.setItem('gasUrl', u); document.getElementById('cloudStatus').textContent = "âœ… å·²é€£çµ"; document.getElementById('cloudStatus').style.color = "green";
    }

    function syncCloud(action) {
        const url = localStorage.getItem('gasUrl'); if(!url) { alert("è«‹å…ˆè¨­å®šç¶²å€"); return; }
        const s = document.getElementById('cloudStatus'); s.textContent = (action === 'backup') ? "å‚™ä»½ä¸­..." : "é‚„åŸä¸­...";
        if(action === 'backup') {
            fetch(url, { method: 'POST', body: JSON.stringify(racesData) }).then(r=>r.json()).then(d=>{
                if(d.status==='success') { alert("å‚™ä»½æˆåŠŸ"); s.textContent="âœ… å‚™ä»½æˆåŠŸ"; s.style.color="green"; } else throw new Error(d.message);
            }).catch(e=>{ alert("å¤±æ•—:"+e); s.textContent="âŒ å¤±æ•—"; s.style.color="red"; });
        } else {
            if(!confirm("ç¢ºå®šé‚„åŸï¼Ÿ")) return;
            fetch(url).then(r=>r.json()).then(d=>{
                if(Array.isArray(d)) { racesData = d; refreshData(); alert("é‚„åŸæˆåŠŸ"); s.textContent="âœ… é‚„åŸæˆåŠŸ"; s.style.color="green"; closeCloudModal(); }
            }).catch(e=>{ alert("å¤±æ•—:"+e); s.textContent="âŒ å¤±æ•—"; s.style.color="red"; });
        }
    }
  </script>
</body>
</html>
