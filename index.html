<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é•·è·‘æ¯”è³½ç´€éŒ„ - JSON/CSV ç‰ˆ</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, "Microsoft JhengHei", sans-serif; background:#f0f2f5; padding:20px; }
    
    /* Container èˆ‡ Header */
    .container { max-width: 1800px; margin:0 auto; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.15); overflow:hidden; }
    header { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; padding:20px; text-align:center; }
    header h1 { font-size:1.8em; margin-bottom:5px; }
    header p { font-size: 0.9em; opacity: 0.9; }

    /* --- æ–°ç‰ˆ Controls ä½ˆå±€ç³»çµ± (v1.0.2) --- */
    .controls {
      padding: 15px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      flex-direction: column;
      gap: 12px; /* ä¸Šä¸‹å€å¡Šé–“è· */
    }

    /* ç¬¬ä¸€æ’ï¼šæœå°‹èˆ‡åƒè³½è€… (æœ€é‡è¦) */
    .control-row-main {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .control-row-main input { flex: 2; min-width: 200px; padding:8px 10px; border-radius:4px; border:1px solid #ccc; }
    .control-row-main select { flex: 1; min-width: 140px; padding:8px 10px; border-radius:4px; border:1px solid #ccc; }

    /* ç¬¬äºŒæ’ï¼šè·é›¢ç¯©é¸èˆ‡åŠŸèƒ½æŒ‰éˆ• */
    .control-row-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* æŒ‰éˆ•ç¾¤çµ„å®¹å™¨ */
    .btn-group {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    /* æŒ‰éˆ•é€šç”¨æ¨£å¼ */
    .controls button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background: #667eea;
      color: #fff;
      cursor: pointer;
      font-size: 0.9em;
      white-space: nowrap; /* é˜²æ­¢æŒ‰éˆ•æ–‡å­—æ›è¡Œ */
      transition: background 0.2s;
    }
    .controls button.secondary { background: #6c757d; }
    .controls button.success { background: #28a745; }
    .controls button.outline { background: transparent; border: 1px solid #6c757d; color: #6c757d; }
    .controls button.outline:hover { background: #e2e6ea; }
    .controls button:hover { opacity: 0.9; }

    /* --- è¡¨æ ¼æ¨£å¼ --- */
    .table-wrapper { padding:15px 20px 20px; overflow-x:auto; max-height:70vh; }
    table { border-collapse:collapse; width:100%; font-size:0.9em; }
    thead th { position:sticky; top:0; background:#667eea; color:#fff; padding:8px 6px; white-space:nowrap; z-index:1; }
    tbody td { padding:6px 6px; border-bottom:1px solid #eee; }
    tbody tr:nth-child(even) { background:#fafafa; }
    tbody tr:hover { background:#f1f3f5; }

    .distance-tag { display:inline-block; padding:2px 6px; border-radius:4px; background:#667eea; color:#fff; font-size:0.8em; }
    .race-number { text-align:center; font-weight:bold; color:#667eea; }
    .action-btn { padding:4px 8px; font-size:0.8em; border:none; border-radius:4px; background:#0d6efd; color:#fff; cursor:pointer; }
    .no-results { text-align:center; padding:30px; color:#777; }
    .footer { padding:10px 20px 15px; background:#f8f9fa; font-size:0.8em; color:#666; border-top:1px solid #e5e5e5; }

    /* ç©ºç™½æ¬„ä½èƒŒæ™¯è‰²ï¼ˆå„ªå…ˆæ–¼ zebra/hoverï¼‰ */
    .empty-cell { background:#fff3cd !important; }
    /* æ¯”è³½æ—¥æœŸä¸è¦æ›è¡Œ */
    .date-cell { white-space:nowrap; }

    /* æ’åºæ¨£å¼ */
    .sortable { cursor:pointer; user-select:none; }
    .sort-indicator { font-size:0.8em; margin-left:4px; opacity:0.8; }

    /* Modal å…±ç”¨æ¨£å¼ */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1000; }
    .modal.show { display:block; }
    .modal-content { background:#fff; max-width:800px; margin:5% auto; padding:20px 20px 15px; border-radius:8px; max-height:85vh; overflow-y:auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .modal-header h2 { font-size:1.3em; }
    .close-btn { border:none; background:none; font-size:1.6em; cursor:pointer; }

    .form-grid { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px; margin-top:10px; }
    .form-grid.full { grid-template-columns:1fr; }
    .form-group label { font-size:0.85em; font-weight:bold; margin-bottom:3px; display:block; }
    .form-group input { width:100%; padding:6px 8px; border-radius:4px; border:1px solid:#ccc; font-size:0.85em; }

    .modal-buttons { display:flex; justify-content:flex-end; gap:8px; margin-top:15px; }
    .modal-buttons .secondary { background:#6c757d; color:#fff; }
    .modal-buttons .delete-btn { background:#dc3545; color:#fff; }
    .modal-buttons .success { background:#28a745; color:#fff; }

    /* ä¸‹è¼‰å€å¡Šæ¨£å¼ */
    .demo-download-area {
      background: #eef2f7;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
      font-size: 0.9em;
      line-height: 1.6;
    }
    .demo-download-area a { color: #0d6efd; text-decoration: none; font-weight: bold; margin: 0 5px; }
    .demo-download-area a:hover { text-decoration: underline; }

    /* --- æ‰‹æ©Ÿç‰ˆé‡å°æ€§å„ªåŒ– (é—œéµä¿®æ­£ v1.0.2) --- */
    @media (max-width: 768px) {
      body { padding: 0; background: #fff; } /* ç§»é™¤ body padding çˆ­å–ç©ºé–“ */
      .container { border-radius: 0; box-shadow: none; } /* æ‰‹æ©Ÿç‰ˆä¸éœ€è¦åœ“è§’é™°å½± */
      header { padding: 15px 10px; }
      header h1 { font-size: 1.4em; }
      
      .controls { padding: 10px; gap: 10px; }
      
      /* æœå°‹èˆ‡ç¯©é¸ç¶­æŒç›´å¼ï¼Œä½†é–“è·ç¸®å° */
      .control-row-main { flex-direction: column; gap: 8px; }
      .control-row-main input, .control-row-main select { width: 100%; flex: none; }

      /* ç¬¬äºŒæ’æ”¹ç‚º Grid ä½ˆå±€ï¼Œå¼·åˆ¶ä¸€è¡Œé¡¯ç¤ºå¤šå€‹æŒ‰éˆ• */
      .control-row-actions { display: block; } /* å–æ¶ˆ flexï¼Œæ”¹ç”±å…§éƒ¨ group æ§åˆ¶ */
      
      .btn-group {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* å¼·åˆ¶ä¸€è¡Œ4å€‹ */
        gap: 5px;
        margin-bottom: 8px;
      }
      
      /* æª”æ¡ˆæ“ä½œæŒ‰éˆ•ï¼šä¸€è¡Œ2å€‹ */
      .btn-group.file-ops {
        grid-template-columns: repeat(2, 1fr);
      }
      
      /* æŒ‰éˆ•æ–‡å­—ç¸®å°ä»¥æ”¾å…¥ä¸€è¡Œ */
      .controls button { padding: 8px 4px; font-size: 0.85em; }
      
      table { font-size:0.8em; }
      .form-grid { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸƒâ€â™‚ï¸ é•·è·‘æ¯”è³½ç´€éŒ„</h1>
      <p>ä»¥ JSON / CSV ç‚ºæ­£æœ¬çš„äº’å‹•æ¸…å–®ï¼ˆä¸ä½¿ç”¨ localStorageï¼‰</p>
    </header>

    <div class="controls">
      <div class="control-row-main">
        <input id="searchInput" type="text" placeholder="ğŸ” æœå°‹åç¨±ã€åœ°é»æˆ–ç·¨è™Ÿ...">
        <select id="runnerFilter" onchange="onRunnerFilterChange()">
          <option value="">åƒè³½è€…(å…¨éƒ¨)</option>
        </select>
      </div>

      <div class="control-row-actions">
        <div class="btn-group">
          <button onclick="filterByDistance('10')">10km</button>
          <button onclick="filterByDistance('21')">åŠé¦¬</button>
          <button onclick="filterByDistance('42')">å…¨é¦¬</button>
          <button onclick="filterByDistance('OTHER')">å…¶ä»–</button>
        </div>

        <div class="btn-group">
          <button class="secondary outline" onclick="resetFilters()">é‡ç½®</button>
          <button class="success" onclick="openAddModal()">ï¼‹æ–°å¢</button>
        </div>

        <div class="btn-group file-ops">
          <button class="secondary" onclick="triggerImportJson()">åŒ¯å…¥ JSON</button>
          <button class="secondary" onclick="downloadJSON()">åŒ¯å‡º JSON</button>
          <button class="secondary" onclick="triggerImportCsv()">åŒ¯å…¥ CSV</button>
          <button class="secondary" onclick="downloadCSV()">åŒ¯å‡º CSV</button>
        </div>
      </div>

      <input id="importJsonFile" type="file" accept=".json,application/json" style="display:none" onchange="importJSON(this.files[0])">
      <input id="importCsvFile" type="file" accept=".csv,text/csv" style="display:none" onchange="importCSV(this.files[0])">
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th class="sortable" onclick="changeSort('ç·¨è™Ÿ')">
              ç·¨è™Ÿ<span class="sort-indicator" id="sort-ç·¨è™Ÿ">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('ä¸­æ–‡åç¨±')">
              ä¸­æ–‡åç¨±<span class="sort-indicator" id="sort-ä¸­æ–‡åç¨±">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('è‹±æ–‡åç¨±')">
              è‹±æ–‡åç¨±<span class="sort-indicator" id="sort-è‹±æ–‡åç¨±">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('æ¯”è³½æ—¥æœŸ')">
              æ¯”è³½æ—¥æœŸ<span class="sort-indicator" id="sort-æ¯”è³½æ—¥æœŸ">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('è·é›¢')">
              è·é›¢<span class="sort-indicator" id="sort-è·é›¢">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('åœ°é»')">
              åœ°é»<span class="sort-indicator" id="sort-åœ°é»">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('ä¸»è¾¦å–®ä½')">
              ä¸»è¾¦å–®ä½<span class="sort-indicator" id="sort-ä¸»è¾¦å–®ä½">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('èµ·æ­¥æ™‚é–“')">
              èµ·æ­¥æ™‚é–“<span class="sort-indicator" id="sort-èµ·æ­¥æ™‚é–“">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('è³½äº‹çµ„åˆ¥')">
              è³½äº‹çµ„åˆ¥<span class="sort-indicator" id="sort-è³½äº‹çµ„åˆ¥">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('åƒè³½ç·¨è™Ÿ')">
              åƒè³½ç·¨è™Ÿ<span class="sort-indicator" id="sort-åƒè³½ç·¨è™Ÿ">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('åƒè³½è€…')">
              åƒè³½è€…<span class="sort-indicator" id="sort-åƒè³½è€…">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('æº«åº¦')">
              æº«åº¦(Â°C)<span class="sort-indicator" id="sort-æº«åº¦">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('çµ„åˆ¥åæ¬¡')">
              çµ„åˆ¥åæ¬¡<span class="sort-indicator" id="sort-çµ„åˆ¥åæ¬¡">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('ç¸½åæ¬¡')">
              ç¸½åæ¬¡<span class="sort-indicator" id="sort-ç¸½åæ¬¡">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('å®Œæˆæ™‚é–“')">
              å®Œæˆæ™‚é–“<span class="sort-indicator" id="sort-å®Œæˆæ™‚é–“">â†•</span>
            </th>
            <th class="sortable" onclick="changeSort('å‚™è¨»')">
              å‚™è¨»<span class="sort-indicator" id="sort-å‚™è¨»">â†•</span>
            </th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div id="noResults" class="no-results" style="display:none;">
        ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œè«‹åŒ¯å…¥ JSON / CSV æˆ–æ–°å¢æ¯”è³½
      </div>
    </div>

    <div class="footer">
      å»ºè­°ï¼šæ¯ä¸€å€‹ JSON æˆ– CSV æª”æ¡ˆä»£è¡¨ä¸€å¥—ã€Œé•·è·‘æ¯”è³½ç´€éŒ„ã€ã€‚<br>
      é–‹å•Ÿæœ¬ HTML â†’ å…ˆåŒ¯å…¥ JSON/CSV â†’ ç·¨è¼¯ / æ–°å¢æ¯”è³½ â†’ é—œé–‰å‰è«‹å‹™å¿…åŒ¯å‡º JSON å‚™ä»½ã€‚<br>
      â€» è‹¥æ‚¨ç¿’æ…£ä½¿ç”¨ Excel ç·¨è¼¯ï¼Œå¯ä¸‹è¼‰ <a href="./test_races.csv" download>CSV ç¯„ä¾‹æª”</a>ï¼Œç·¨è¼¯å¾Œå†åŒ¯å…¥æœ¬ç³»çµ±ã€‚
    </div>
  </div>

  <div id="startupModal" class="modal show">
    <div class="modal-content">
      <div class="modal-header">
        <h2>è¼‰å…¥æ¯”è³½è³‡æ–™</h2>
      </div>
      
      <div class="demo-download-area">
        <strong>ğŸ†• åˆæ¬¡ä½¿ç”¨ï¼Ÿ</strong><br>
        å¦‚æœæ‚¨æ‰‹é‚Šæ²’æœ‰è³‡æ–™ï¼Œå¯ä»¥ä¸‹è¼‰ä»¥ä¸‹ç¯„ä¾‹æª”æ¡ˆé€²è¡Œæ¸¬è©¦ï¼š<br>
        ğŸ“¥ <a href="./test_races.json" target="_blank" download>ä¸‹è¼‰ JSON æ¸¬è©¦è³‡æ–™</a> (å«å¤šç­†ç¯„ä¾‹)<br>
        ğŸ“¥ <a href="./test_races.csv" target="_blank" download>ä¸‹è¼‰ CSV ç¯„ä¾‹æª”</a> (å¯ä½¿ç”¨ Excel ç·¨è¼¯å¾ŒåŒ¯å…¥)
      </div>

      <p style="margin-top:5px; margin-bottom:10px; font-size:0.9em;">
        è«‹é¸æ“‡è¦è¼‰å…¥çš„æ–¹å¼ï¼š
      </p>
      <div class="modal-buttons" style="justify-content:flex-start;">
        <button class="secondary" onclick="triggerImportJson()">å¾ JSON åŒ¯å…¥</button>
        <button class="secondary" onclick="triggerImportCsv()">å¾ CSV åŒ¯å…¥</button>
        <button class="success" onclick="startWithEmpty()">å¾ç©ºç™½é–‹å§‹</button>
      </div>
      <p style="margin-top:10px; font-size:0.8em; color:#666;">
        ï¼ˆä¹‹å¾Œå¯ç”¨ä¸Šæ–¹æŒ‰éˆ•éš¨æ™‚å†åŒ¯å‡º JSON / CSV å‚™ä»½ï¼‰
      </p>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">ç·¨è¼¯æ¯”è³½è¨˜éŒ„</h2>
        <button class="close-btn" onclick="closeEditModal()">Ã—</button>
      </div>

      <div class="form-grid full">
        <div class="form-group">
          <label>ç·¨è™Ÿ</label>
          <input id="f_ç·¨è™Ÿ" type="number" readonly>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>ä¸­æ–‡åç¨±</label>
          <input id="f_ä¸­æ–‡åç¨±" type="text" list="list-cn-name">
          <datalist id="list-cn-name"></datalist>
        </div>
        <div class="form-group">
          <label>è‹±æ–‡åç¨±</label>
          <input id="f_è‹±æ–‡åç¨±" type="text" list="list-en-name">
          <datalist id="list-en-name"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>æ¯”è³½æ—¥æœŸ</label>
          <input id="f_æ¯”è³½æ—¥æœŸ" type="date">
        </div>
        <div class="form-group">
          <label>è·é›¢</label>
          <input id="f_è·é›¢" type="text" placeholder="ä¾‹å¦‚ï¼š10 km / 21.095 km / 42.195 km" list="list-distance">
          <datalist id="list-distance"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>åœ°é»</label>
          <input id="f_åœ°é»" type="text" list="list-location">
          <datalist id="list-location"></datalist>
        </div>
        <div class="form-group">
          <label>è²»ç”¨</label>
          <input id="f_è²»ç”¨" type="text" list="list-fee">
          <datalist id="list-fee"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>ä¸»è¾¦å–®ä½</label>
          <input id="f_ä¸»è¾¦å–®ä½" type="text" list="list-org">
          <datalist id="list-org"></datalist>
        </div>
        <div class="form-group">
          <label>èµ·æ­¥æ™‚é–“</label>
          <input id="f_èµ·æ­¥æ™‚é–“" type="text" placeholder="ä¾‹å¦‚ï¼š06:00" list="list-start-time">
          <datalist id="list-start-time"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>è³½äº‹çµ„åˆ¥</label>
          <input id="f_è³½äº‹çµ„åˆ¥" type="text" list="list-category">
          <datalist id="list-category"></datalist>
        </div>
        <div class="form-group">
          <label>åƒè³½ç·¨è™Ÿ</label>
          <input id="f_åƒè³½ç·¨è™Ÿ" type="text" list="list-bib">
          <datalist id="list-bib"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>åƒè³½è€…</label>
          <input id="f_åƒè³½è€…" type="text" list="runnerList">
          <datalist id="runnerList"></datalist>
        </div>
        <div class="form-group">
          <label>æº«åº¦(Â°C)</label>
          <input id="f_æº«åº¦" type="number" step="0.1" list="list-temp">
          <datalist id="list-temp"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>çµ„åˆ¥åæ¬¡</label>
          <input id="f_çµ„åˆ¥åæ¬¡" type="number" list="list-rank-group">
          <datalist id="list-rank-group"></datalist>
        </div>
        <div class="form-group">
          <label>ç¸½åæ¬¡</label>
          <input id="f_ç¸½åæ¬¡" type="number" list="list-rank-overall">
          <datalist id="list-rank-overall"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>å®Œæˆæ™‚é–“</label>
          <input id="f_å®Œæˆæ™‚é–“" type="text" placeholder="ä¾‹å¦‚ï¼š3:45:12" list="list-finish">
          <datalist id="list-finish"></datalist>
        </div>
        <div class="form-group">
          <label>å‚™è¨»</label>
          <input id="f_å‚™è¨»" type="text" list="list-note">
          <datalist id="list-note"></datalist>
        </div>
      </div>

      <div class="modal-buttons">
        <button class="secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
        <button id="deleteBtn" class="delete-btn" onclick="deleteRace()">åˆªé™¤</button>
        <button class="success" onclick="saveRace()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    const FIELDS = [
      "ç·¨è™Ÿ","ä¸­æ–‡åç¨±","è‹±æ–‡åç¨±","æ¯”è³½æ—¥æœŸ","è·é›¢","åœ°é»","è²»ç”¨",
      "ä¸»è¾¦å–®ä½","èµ·æ­¥æ™‚é–“","è³½äº‹çµ„åˆ¥","åƒè³½ç·¨è™Ÿ","åƒè³½è€…","æº«åº¦",
      "çµ„åˆ¥åæ¬¡","ç¸½åæ¬¡","å®Œæˆæ™‚é–“","å‚™è¨»"
    ];

    let racesData = [];
    let filtered = [];
    let currentIndex = -1;
    let currentDistanceKey = "";
    let sortField = "æ¯”è³½æ—¥æœŸ";
    let sortDir = "desc";
    let currentRunnerFilter = "";

    function setDatalistOptionsFromField(fieldName, datalistId) {
      const dl = document.getElementById(datalistId);
      if (!dl) return;
      const values = Array.from(new Set(
        racesData
          .map(r => (r[fieldName] || "").trim())
          .filter(Boolean)
      )).sort((a, b) => a.localeCompare(b, "zh-Hant"));
      dl.innerHTML = values
        .map(v => `<option value="${v.replace(/"/g, "&quot;")}"></option>`)
        .join("");
    }

    function refreshSuggestionLists() {
      const rawNames = racesData
        .map(r => (r["åƒè³½è€…"] || "").trim())
        .filter(Boolean);
      const names = Array.from(new Set(rawNames))
        .sort((a, b) => a.localeCompare(b, "zh-Hant"));

      const runnerDl = document.getElementById("runnerList");
      if (runnerDl) {
        runnerDl.innerHTML = names
          .map(n => `<option value="${n.replace(/"/g, "&quot;")}"></option>`)
          .join("");
      }

      const runnerSelect = document.getElementById("runnerFilter");
      if (runnerSelect) {
        let html = `<option value="">åƒè³½è€…(å…¨éƒ¨)</option>`;
        html += names
          .map(n => {
            const esc = n.replace(/"/g, "&quot;");
            return `<option value="${esc}">${esc}</option>`;
          })
          .join("");
        runnerSelect.innerHTML = html;

        if (currentRunnerFilter && names.includes(currentRunnerFilter)) {
          runnerSelect.value = currentRunnerFilter;
        } else {
          currentRunnerFilter = "";
          runnerSelect.value = "";
        }
      }

      setDatalistOptionsFromField("ä¸­æ–‡åç¨±", "list-cn-name");
      setDatalistOptionsFromField("è‹±æ–‡åç¨±", "list-en-name");
      setDatalistOptionsFromField("è·é›¢", "list-distance");
      setDatalistOptionsFromField("åœ°é»", "list-location");
      setDatalistOptionsFromField("è²»ç”¨", "list-fee");
      setDatalistOptionsFromField("ä¸»è¾¦å–®ä½", "list-org");
      setDatalistOptionsFromField("èµ·æ­¥æ™‚é–“", "list-start-time");
      setDatalistOptionsFromField("è³½äº‹çµ„åˆ¥", "list-category");
      setDatalistOptionsFromField("åƒè³½ç·¨è™Ÿ", "list-bib");
      setDatalistOptionsFromField("æº«åº¦", "list-temp");
      setDatalistOptionsFromField("çµ„åˆ¥åæ¬¡", "list-rank-group");
      setDatalistOptionsFromField("ç¸½åæ¬¡", "list-rank-overall");
      setDatalistOptionsFromField("å®Œæˆæ™‚é–“", "list-finish");
      setDatalistOptionsFromField("å‚™è¨»", "list-note");
    }

    function compareForField(a, b, field) {
      let v1 = a[field];
      let v2 = b[field];
      if (v1 == null) v1 = "";
      if (v2 == null) v2 = "";

      if (field === "æ¯”è³½æ—¥æœŸ") {
        if (!v1 && !v2) return 0;
        if (!v1) return 1;
        if (!v2) return -1;
        return v1.localeCompare(v2);
      }

      if (["ç·¨è™Ÿ", "æº«åº¦", "çµ„åˆ¥åæ¬¡", "ç¸½åæ¬¡"].includes(field)) {
        const n1 = parseFloat(v1) || 0;
        const n2 = parseFloat(v2) || 0;
        return n1 - n2;
      }

      v1 = String(v1).toLowerCase();
      v2 = String(v2).toLowerCase();
      return v1.localeCompare(v2, "zh-Hant");
    }

    function sortFiltered() {
      if (!sortField) return;
      filtered.sort(function(a, b) {
        let cmp = compareForField(a, b, sortField);
        if (sortDir === "desc") cmp = -cmp;
        return cmp;
      });
    }

    function createCell(innerHTML, isEmpty) {
      const cls = isEmpty ? "empty-cell" : "";
      return `<td class="${cls}">${innerHTML}</td>`;
    }

    function renderTable(list) {
      const tbody = document.getElementById("tableBody");
      const noRes = document.getElementById("noResults");
      if (!list.length) {
        tbody.innerHTML = "";
        noRes.style.display = "block";
        return;
      }
      noRes.style.display = "none";

      const rowsHtml = list.map(function(r) {
        const id = r["ç·¨è™Ÿ"] ?? "";
        const cn = r["ä¸­æ–‡åç¨±"] || "";
        const en = r["è‹±æ–‡åç¨±"] || "";
        const date = r["æ¯”è³½æ—¥æœŸ"] || "";
        const dist = r["è·é›¢"] || "";
        const place = r["åœ°é»"] || "";
        const org = r["ä¸»è¾¦å–®ä½"] || "";
        const start = r["èµ·æ­¥æ™‚é–“"] || "";
        const group = r["è³½äº‹çµ„åˆ¥"] || "";
        const bib = r["åƒè³½ç·¨è™Ÿ"] || "";
        const runner = r["åƒè³½è€…"] || "";
        const temp = r["æº«åº¦"] || "";
        const rankGroup = r["çµ„åˆ¥åæ¬¡"] || "";
        const rankOverall = r["ç¸½åæ¬¡"] || "";
        const finish = r["å®Œæˆæ™‚é–“"] || "";
        const note = r["å‚™è¨»"] || "";

        const distanceHtml = dist ? `<span class="distance-tag">${dist}</span>` : "";
        const dateClasses = date ? "date-cell" : "date-cell empty-cell";

        return `<tr>
          ${createCell(id, !id)}
          ${createCell(cn, !cn)}
          ${createCell(en, !en)}
          <td class="${dateClasses}">${date}</td>
          ${createCell(distanceHtml, !dist)}
          ${createCell(place, !place)}
          ${createCell(org, !org)}
          ${createCell(start, !start)}
          ${createCell(group, !group)}
          ${createCell(bib, !bib)}
          ${createCell(runner, !runner)}
          ${createCell(temp, !temp)}
          ${createCell(rankGroup, !rankGroup)}
          ${createCell(rankOverall, !rankOverall)}
          ${createCell(finish, !finish)}
          ${createCell(note, !note)}
          <td>
            <button class="action-btn" onclick="openEditModal(${id || 0})">ç·¨è¼¯</button>
          </td>
        </tr>`;
      }).join("");

      tbody.innerHTML = rowsHtml;
    }

    function applyFilters() {
      const q = document.getElementById("searchInput").value.toLowerCase();
      filtered = racesData.filter(function(r) {
        const cn = (r["ä¸­æ–‡åç¨±"] || "").toLowerCase();
        const en = (r["è‹±æ–‡åç¨±"] || "").toLowerCase();
        const loc = (r["åœ°é»"] || "").toLowerCase();
        const bib = (r["åƒè³½ç·¨è™Ÿ"] || "").toLowerCase();
        const matchText = !q || cn.includes(q) || en.includes(q) || loc.includes(q) || bib.includes(q);

        const distStr = r["è·é›¢"] || "";
        let matchDistance = true;
        if (currentDistanceKey === "OTHER") {
          matchDistance = !distStr ||
            (!distStr.includes("10") && !distStr.includes("21") && !distStr.includes("42"));
        } else if (currentDistanceKey) {
          matchDistance = distStr.includes(currentDistanceKey);
        }

        const runnerField = (r["åƒè³½è€…"] || "").trim();
        const matchRunner = !currentRunnerFilter || runnerField === currentRunnerFilter;

        return matchText && matchDistance && matchRunner;
      });

      sortFiltered();
      renderTable(filtered);
    }

    function filterByDistance(key) {
      currentDistanceKey = key;
      applyFilters();
    }

    function resetFilters() {
      document.getElementById("searchInput").value = "";
      currentDistanceKey = "";
      currentRunnerFilter = "";
      const sel = document.getElementById("runnerFilter");
      if (sel) sel.value = "";
      applyFilters();
      updateSortIndicators();
    }

    function onRunnerFilterChange() {
      const sel = document.getElementById("runnerFilter");
      currentRunnerFilter = sel ? sel.value : "";
      applyFilters();
    }

    function changeSort(field) {
      if (sortField === field) {
        sortDir = (sortDir === "asc") ? "desc" : "asc";
      } else {
        sortField = field;
        sortDir = (field === "æ¯”è³½æ—¥æœŸ") ? "desc" : "asc";
      }
      applyFilters();
      updateSortIndicators();
    }

    function updateSortIndicators() {
      const indicators = document.querySelectorAll(".sort-indicator");
      indicators.forEach(span => span.textContent = "â†•");
      if (!sortField) return;
      const el = document.getElementById("sort-" + sortField);
      if (!el) return;
      el.textContent = (sortDir === "asc") ? "â†‘" : "â†“";
    }

    function openEditModal(id) {
      currentIndex = racesData.findIndex(function(r) { return r["ç·¨è™Ÿ"] === id; });
      if (currentIndex === -1) return;
      const r = racesData[currentIndex];

      document.getElementById("modalTitle").textContent = "ç·¨è¼¯æ¯”è³½è¨˜éŒ„";
      document.getElementById("deleteBtn").style.display = "inline-block";

      document.getElementById("f_ç·¨è™Ÿ").value = r["ç·¨è™Ÿ"] ?? "";
      document.getElementById("f_ä¸­æ–‡åç¨±").value = r["ä¸­æ–‡åç¨±"] || "";
      document.getElementById("f_è‹±æ–‡åç¨±").value = r["è‹±æ–‡åç¨±"] || "";
      document.getElementById("f_æ¯”è³½æ—¥æœŸ").value = r["æ¯”è³½æ—¥æœŸ"] || "";
      document.getElementById("f_è·é›¢").value = r["è·é›¢"] || "";
      document.getElementById("f_åœ°é»").value = r["åœ°é»"] || "";
      document.getElementById("f_è²»ç”¨").value = r["è²»ç”¨"] || "";
      document.getElementById("f_ä¸»è¾¦å–®ä½").value = r["ä¸»è¾¦å–®ä½"] || "";
      document.getElementById("f_èµ·æ­¥æ™‚é–“").value = r["èµ·æ­¥æ™‚é–“"] || "";
      document.getElementById("f_è³½äº‹çµ„åˆ¥").value = r["è³½äº‹çµ„åˆ¥"] || "";
      document.getElementById("f_åƒè³½ç·¨è™Ÿ").value = r["åƒè³½ç·¨è™Ÿ"] || "";
      document.getElementById("f_åƒè³½è€…").value = r["åƒè³½è€…"] || "";
      document.getElementById("f_æº«åº¦").value = r["æº«åº¦"] || "";
      document.getElementById("f_çµ„åˆ¥åæ¬¡").value = r["çµ„åˆ¥åæ¬¡"] || "";
      document.getElementById("f_ç¸½åæ¬¡").value = r["ç¸½åæ¬¡"] || "";
      document.getElementById("f_å®Œæˆæ™‚é–“").value = r["å®Œæˆæ™‚é–“"] || "";
      document.getElementById("f_å‚™è¨»").value = r["å‚™è¨»"] || "";

      refreshSuggestionLists();
      document.getElementById("editModal").classList.add("show");
    }

    function openAddModal() {
      currentIndex = -1;
      document.getElementById("modalTitle").textContent = "æ–°å¢æ¯”è³½è¨˜éŒ„";
      document.getElementById("deleteBtn").style.display = "none";

      const maxId = racesData.length
        ? Math.max.apply(null, racesData.map(function(r){ return Number(r["ç·¨è™Ÿ"]) || 0; }))
        : 0;
      document.getElementById("f_ç·¨è™Ÿ").value = maxId + 1;

      ["ä¸­æ–‡åç¨±","è‹±æ–‡åç¨±","è·é›¢","åœ°é»","è²»ç”¨","ä¸»è¾¦å–®ä½",
       "èµ·æ­¥æ™‚é–“","è³½äº‹çµ„åˆ¥","åƒè³½ç·¨è™Ÿ","åƒè³½è€…","æº«åº¦",
       "çµ„åˆ¥åæ¬¡","ç¸½åæ¬¡","å®Œæˆæ™‚é–“","å‚™è¨»"
      ].forEach(function(k) {
        const el = document.getElementById("f_" + k);
        if (el) el.value = "";
      });
      document.getElementById("f_æ¯”è³½æ—¥æœŸ").value = "";

      refreshSuggestionLists();
      document.getElementById("editModal").classList.add("show");
    }

    function closeEditModal() {
      document.getElementById("editModal").classList.remove("show");
    }

    function saveRace() {
      const idVal = parseInt(document.getElementById("f_ç·¨è™Ÿ").value, 10);
      const rec = {
        "ç·¨è™Ÿ": isNaN(idVal) ? null : idVal,
        "ä¸­æ–‡åç¨±": document.getElementById("f_ä¸­æ–‡åç¨±").value.trim(),
        "è‹±æ–‡åç¨±": document.getElementById("f_è‹±æ–‡åç¨±").value.trim(),
        "æ¯”è³½æ—¥æœŸ": document.getElementById("f_æ¯”è³½æ—¥æœŸ").value,
        "è·é›¢": document.getElementById("f_è·é›¢").value.trim(),
        "åœ°é»": document.getElementById("f_åœ°é»").value.trim(),
        "è²»ç”¨": document.getElementById("f_è²»ç”¨").value.trim(),
        "ä¸»è¾¦å–®ä½": document.getElementById("f_ä¸»è¾¦å–®ä½").value.trim(),
        "èµ·æ­¥æ™‚é–“": document.getElementById("f_èµ·æ­¥æ™‚é–“").value.trim(),
        "è³½äº‹çµ„åˆ¥": document.getElementById("f_è³½äº‹çµ„åˆ¥").value.trim(),
        "åƒè³½ç·¨è™Ÿ": document.getElementById("f_åƒè³½ç·¨è™Ÿ").value.trim(),
        "åƒè³½è€…": document.getElementById("f_åƒè³½è€…").value.trim(),
        "æº«åº¦": document.getElementById("f_æº«åº¦").value,
        "çµ„åˆ¥åæ¬¡": document.getElementById("f_çµ„åˆ¥åæ¬¡").value,
        "ç¸½åæ¬¡": document.getElementById("f_ç¸½åæ¬¡").value,
        "å®Œæˆæ™‚é–“": document.getElementById("f_å®Œæˆæ™‚é–“").value.trim(),
        "å‚™è¨»": document.getElementById("f_å‚™è¨»").value.trim()
      };

      if (!rec["ä¸­æ–‡åç¨±"] && !rec["è‹±æ–‡åç¨±"]) {
        alert("è«‹è‡³å°‘è¼¸å…¥ä¸­æ–‡æˆ–è‹±æ–‡åç¨±ã€‚");
        return;
      }

      if (!rec["ç·¨è™Ÿ"]) {
        const maxId = racesData.length
          ? Math.max.apply(null, racesData.map(function(r){ return Number(r["ç·¨è™Ÿ"]) || 0; }))
          : 0;
        rec["ç·¨è™Ÿ"] = maxId + 1;
      }

      if (currentIndex === -1) {
        racesData.push(rec);
      } else {
        racesData[currentIndex] = rec;
      }

      refreshSuggestionLists();
      applyFilters();
      closeEditModal();
    }

    function deleteRace() {
      if (currentIndex === -1) return;
      if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤æ¯”è³½è¨˜éŒ„å—ï¼Ÿ")) return;
      racesData.splice(currentIndex, 1);
      refreshSuggestionLists();
      applyFilters();
      closeEditModal();
    }

    function triggerImportJson() {
      document.getElementById("importJsonFile").click();
    }

    function downloadJSON(auto) {
      if (!racesData.length) {
        if (!auto) alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚");
        return;
      }
      const jsonStr = JSON.stringify(racesData, null, 2);
      const blob = new Blob([jsonStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const stamp = auto
        ? "-" + new Date().toISOString().slice(0,19).replace(/[:T]/g,"")
        : "";
      a.href = url;
      a.download = "Running-Race-Records" + stamp + ".json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importJSON(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data)) {
            alert("JSON æ ¼å¼ä¸æ­£ç¢ºï¼šéœ€è¦ç‚ºé™£åˆ—ã€‚");
            return;
          }
          racesData = data.map(function(r, idx) {
            const rec = {};
            FIELDS.forEach(function(f) {
              rec[f] = "";
              if (r && r[f] != null) rec[f] = r[f];
            });
            if (r) {
              if (!rec["å®Œæˆæ™‚é–“"] && r["å®Œæˆæ™‚é–“ "] != null) rec["å®Œæˆæ™‚é–“"] = r["å®Œæˆæ™‚é–“ "];
              if (!rec["å‚™è¨»"] && r["å‚™è¨» "] != null) rec["å‚™è¨»"] = r["å‚™è¨» "];
            }
            rec["ç·¨è™Ÿ"] = Number(rec["ç·¨è™Ÿ"]) || (idx + 1);
            return rec;
          });
          refreshSuggestionLists();
          applyFilters();
          closeStartupModal();
          alert("JSON åŒ¯å…¥æˆåŠŸï¼");
        } catch (err) {
          console.error(err);
          alert("è®€å– JSON å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆå…§å®¹ã€‚");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    function triggerImportCsv() {
      document.getElementById("importCsvFile").click();
    }

    function toCsvValue(value) {
      if (value == null) return "";
      const s = String(value);
      if (/[",\n]/.test(s)) {
        return '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    }

    function downloadCSV() {
      if (!racesData.length) {
        alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚");
        return;
      }
      const lines = [];
      lines.push(FIELDS.join(","));
      racesData.forEach(function(r) {
        const row = FIELDS.map(function(f) {
          return toCsvValue(r[f] != null ? r[f] : "");
        });
        lines.push(row.join(","));
      });
      const csvStr = lines.join("\r\n");
      const blob = new Blob([csvStr], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "Running-Race-Records.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let field = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (i + 1 < text.length && text[i + 1] === '"') {
              field += '"';
              i++;
            } else {
              inQuotes = false;
            }
          } else {
            field += c;
          }
        } else {
          if (c === '"') {
            inQuotes = true;
          } else if (c === ",") {
            row.push(field);
            field = "";
          } else if (c === "\r") {
            // ignore
          } else if (c === "\n") {
            row.push(field);
            rows.push(row);
            row = [];
            field = "";
          } else {
            field += c;
          }
        }
      }
      if (field !== "" || row.length) {
        row.push(field);
        rows.push(row);
      }
      return rows;
    }

    function importCSV(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const rows = parseCSV(text);
          if (!rows.length) {
            alert("CSV æª”æ¡ˆæ˜¯ç©ºçš„ã€‚");
            return;
          }
          const headerRaw = rows[0];
          const headerTrim = headerRaw.map(function(h) {
            return (h || "").trim();
          });

          const idIndex = headerTrim.indexOf("ç·¨è™Ÿ");
          if (idIndex === -1) {
            alert("CSV å¿…é ˆè‡³å°‘åŒ…å«ã€Œç·¨è™Ÿã€æ¬„ä½ã€‚");
            return;
          }

          const indexes = FIELDS.map(function(name) {
            return headerTrim.indexOf(name);
          });

          const records = [];
          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.every(function(c) { return !c || !String(c).trim(); })) {
              continue;
            }
            const rec = {};
            FIELDS.forEach(function(name, idx) {
              const colIndex = indexes[idx];
              const val = (colIndex >= 0 && row[colIndex] != null) ? row[colIndex].trim() : "";
              rec[name] = val;
            });
            rec["ç·¨è™Ÿ"] = Number(rec["ç·¨è™Ÿ"]) || (records.length + 1);
            records.push(rec);
          }

          racesData = records;
          refreshSuggestionLists();
          applyFilters();
          closeStartupModal();
          alert("CSV åŒ¯å…¥æˆåŠŸï¼");
        } catch (err) {
          console.error(err);
          alert("è®€å– CSV å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆå…§å®¹ã€‚");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    function closeStartupModal() {
      const modal = document.getElementById("startupModal");
      if (modal) modal.classList.remove("show");
    }

    function startWithEmpty() {
      racesData = [];
      refreshSuggestionLists();
      applyFilters();
      closeStartupModal();
    }

    window.addEventListener("beforeunload", function(e) {
      if (!racesData.length) return;
      try {
        downloadJSON(true);
      } catch (err) {
        console.error("è‡ªå‹•åŒ¯å‡º JSON å¤±æ•—", err);
      }
      e.preventDefault();
      e.returnValue = "";
    });

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    applyFilters();
    updateSortIndicators();
    refreshSuggestionLists();
  </script>
</body>
</html>
