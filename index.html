<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é•·è·‘æ¯”è³½ç´€éŒ„ - v1.1.0</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, "Microsoft JhengHei", sans-serif; background:#f0f2f5; padding:20px; }
    
    /* Container */
    .container { max-width: 1800px; margin:0 auto; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.15); overflow:visible; min-height: 80vh; position: relative;}
    header { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; padding:20px; text-align:center; border-radius: 12px 12px 0 0; }
    header h1 { font-size:1.8em; margin-bottom:5px; }
    header p { font-size: 0.9em; opacity: 0.9; }

    /* --- Controls (v1.1.0 é‡æ§‹) --- */
    .controls {
      padding: 15px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ç¬¬ä¸€æ’ï¼šæœå°‹ (ä½”æ»¿) */
    .control-row-top { width: 100%; }
    .control-row-top input { width: 100%; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:1em; }

    /* ç¬¬äºŒæ’ï¼šç¯©é¸å™¨èˆ‡è¨­å®š (Flex) */
    .control-row-filters {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* ä¸‹æ‹‰é¸å–®æ¨£å¼ */
    .filter-select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 0.95em;
      min-width: 100px;
      flex: 1; /* è®“å®ƒå€‘å¹³å‡åˆ†é…ç©ºé–“ */
    }
    /* åƒè³½è€…ç¨å¾®å¯¬ä¸€é» */
    #runnerFilter { flex: 1.5; min-width: 120px; }

    /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ•ç¾¤ (Radio style) */
    .view-mode-group {
      display: flex;
      background: #e9ecef;
      border-radius: 6px;
      padding: 2px;
      flex: none; /* ä¸è¦ç¸®æ”¾ */
    }
    .view-mode-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.9em;
      border-radius: 4px;
      color: #666;
    }
    .view-mode-btn.active {
      background: #fff;
      color: #667eea;
      font-weight: bold;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* è¨­å®šæŒ‰éˆ•èˆ‡æµ®å‹•é¸å–® */
    .settings-container {
      position: relative;
      margin-left: auto; /* æ¨åˆ°æœ€å³é‚Š */
    }
    .settings-btn {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 40px;
      height: 38px;
      cursor: pointer;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .settings-btn:hover { background: #f0f0f0; }

    /* æµ®å‹•é¸å–® */
    .settings-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      width: 200px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      z-index: 100;
      padding: 8px 0;
      margin-top: 5px;
    }
    .settings-menu.show { display: block; }
    
    .menu-item {
      display: block;
      width: 100%;
      padding: 10px 15px;
      text-align: left;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.95em;
      color: #333;
    }
    .menu-item:hover { background: #f8f9fa; color: #667eea; }
    .menu-divider { border-top: 1px solid #eee; margin: 4px 0; }
    .menu-label { padding: 4px 15px; font-size: 0.8em; color: #999; font-weight: bold; }

    /* æ–°å¢æŒ‰éˆ• (æ”¾åœ¨è¨­å®šæŒ‰éˆ•æ—é‚Š) */
    .add-btn {
      padding: 8px 16px;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .add-btn:hover { background: #218838; }

    /* --- è¡¨æ ¼æ¨£å¼ --- */
    .table-wrapper { padding:15px 20px 20px; overflow-x:auto; max-height:70vh; min-height: 400px; }
    table { border-collapse:collapse; width:100%; font-size:0.9em; min-width: 800px; }
    thead th { position:sticky; top:0; background:#667eea; color:#fff; padding:10px 8px; white-space:nowrap; z-index:1; text-align: left;}
    tbody td { padding:8px 8px; border-bottom:1px solid #eee; vertical-align: middle; }
    tbody tr:nth-child(even) { background:#fafafa; }
    tbody tr:hover { background:#f1f3f5; }

    .distance-tag { display:inline-block; padding:3px 8px; border-radius:12px; background:#e0e7ff; color:#4c51bf; font-size:0.85em; font-weight: bold;}
    .action-btn { padding:4px 8px; font-size:0.85em; border:none; border-radius:4px; background:#0d6efd; color:#fff; cursor:pointer; }
    
    /* å‚™è¨»æ¬„ä½æ¨£å¼ */
    .note-cell { color: #666; font-size: 0.9em; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .empty-cell { background:#fff3cd !important; }
    .date-cell { white-space:nowrap; font-family: monospace; font-size: 0.95em; }

    .sortable { cursor:pointer; user-select:none; }
    .sortable:hover { background: #5a67d8; }
    .sort-indicator { font-size:0.8em; margin-left:4px; opacity:0.8; }

    .footer { padding:10px 20px 15px; background:#f8f9fa; font-size:0.8em; color:#666; border-top:1px solid #e5e5e5; }

    /* Modal */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1000; }
    .modal.show { display:block; }
    .modal-content { background:#fff; max-width:800px; margin:5% auto; padding:20px; border-radius:8px; max-height:85vh; overflow-y:auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .modal-header h2 { font-size:1.4em; color: #333; }
    .close-btn { border:none; background:none; font-size:1.8em; cursor:pointer; color: #999; }
    .close-btn:hover { color: #333; }

    .form-grid { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:15px; margin-top:10px; }
    .form-grid.full { grid-template-columns:1fr; }
    .form-group label { font-size:0.9em; font-weight:bold; margin-bottom:5px; display:block; color: #444; }
    .form-group input { width:100%; padding:8px 10px; border-radius:4px; border:1px solid #ccc; font-size:0.95em; }
    .form-group input:focus { border-color: #667eea; outline: none; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }

    .modal-buttons { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; padding-top: 15px; border-top: 1px solid #eee; }
    .modal-buttons button { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.95em; }
    .modal-buttons .secondary { background:#6c757d; color:#fff; }
    .modal-buttons .delete-btn { background:#dc3545; color:#fff; }
    .modal-buttons .success { background:#28a745; color:#fff; }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body { padding: 0; }
      .container { border-radius: 0; min-height: 100vh; }
      .controls { gap: 10px; }
      .control-row-filters { gap: 8px; }
      .filter-select { min-width: 45%; flex: 1; } /* æ‰‹æ©Ÿä¸Šä¸€è¡Œé¡¯ç¤ºå…©å€‹ */
      #runnerFilter { min-width: 100%; order: -1; } /* åƒè³½è€…åœ¨æ‰‹æ©Ÿä¸Šç¨ä½”ä¸€è¡Œ */
      .settings-container { margin-left: 0; } /* æ‰‹æ©Ÿä¸Šä¸å¼·åˆ¶é å³ */
      .add-btn { flex: 1; justify-content: center; }
      .view-mode-group { margin-left: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸƒâ€â™‚ï¸ é•·è·‘æ¯”è³½ç´€éŒ„</h1>
      <p>v1.1.0 - å¼·å¤§çš„ç¯©é¸èˆ‡æª¢è¦–æ¨¡å¼</p>
    </header>

    <div class="controls">
      <div class="control-row-top">
        <input id="searchInput" type="text" placeholder="ğŸ” æœå°‹æ¯”è³½åç¨±ã€åœ°é»æˆ–ç·¨è™Ÿ...">
      </div>

      <div class="control-row-filters">
        <select id="runnerFilter" class="filter-select" onchange="applyFilters()">
          <option value="">ğŸ‘¤ åƒè³½è€…(å…¨éƒ¨)</option>
        </select>

        <select id="distanceFilter" class="filter-select" onchange="applyFilters()">
          <option value="">ğŸ“ è·é›¢(å…¨éƒ¨)</option>
          <option value="10">10km</option>
          <option value="21">åŠé¦¬ (21km)</option>
          <option value="42">å…¨é¦¬ (42km)</option>
          <option value="OTHER">å…¶ä»–</option>
        </select>

        <select id="yearFilter" class="filter-select" onchange="applyFilters()">
          <option value="">ğŸ“… å¹´ä»½(å…¨éƒ¨)</option>
        </select>

        <select id="monthFilter" class="filter-select" onchange="applyFilters()">
          <option value="">ğŸŒ™ æœˆä»½(å…¨éƒ¨)</option>
          <option value="01">1æœˆ</option>
          <option value="02">2æœˆ</option>
          <option value="03">3æœˆ</option>
          <option value="04">4æœˆ</option>
          <option value="05">5æœˆ</option>
          <option value="06">6æœˆ</option>
          <option value="07">7æœˆ</option>
          <option value="08">8æœˆ</option>
          <option value="09">9æœˆ</option>
          <option value="10">10æœˆ</option>
          <option value="11">11æœˆ</option>
          <option value="12">12æœˆ</option>
        </select>

        <div class="view-mode-group">
          <button class="view-mode-btn active" id="btnModeSimple" onclick="setMode('simple')">ç²¾ç°¡</button>
          <button class="view-mode-btn" id="btnModeDetail" onclick="setMode('detail')">è©³ç´°</button>
        </div>

        <button class="add-btn" onclick="openAddModal()">ï¼‹ æ–°å¢</button>

        <div class="settings-container">
          <button class="settings-btn" onclick="toggleSettings()" title="è¨­å®šèˆ‡åŒ¯å…¥åŒ¯å‡º">âš™ï¸</button>
          
          <div id="settingsMenu" class="settings-menu">
            <div class="menu-label">æª”æ¡ˆæ“ä½œ</div>
            <button class="menu-item" onclick="triggerImportJson()">ğŸ“‚ åŒ¯å…¥ JSON</button>
            <button class="menu-item" onclick="downloadJSON()">ğŸ’¾ åŒ¯å‡º JSON</button>
            <div class="menu-divider"></div>
            <button class="menu-item" onclick="triggerImportCsv()">ğŸ“„ åŒ¯å…¥ CSV</button>
            <button class="menu-item" onclick="downloadCSV()">ğŸ“Š åŒ¯å‡º CSV</button>
            <div class="menu-divider"></div>
            <button class="menu-item" onclick="resetFilters()">ğŸ”„ é‡ç½®æ‰€æœ‰ç¯©é¸</button>
          </div>
        </div>
      </div>

      <input id="importJsonFile" type="file" accept=".json,application/json" style="display:none" onchange="importJSON(this.files[0])">
      <input id="importCsvFile" type="file" accept=".csv,text/csv" style="display:none" onchange="importCSV(this.files[0])">
    </div>

    <div class="table-wrapper">
      <table id="raceTable">
        <thead id="tableHead">
          </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div id="noResults" class="no-results" style="display:none;">
        æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ¯”è³½è³‡æ–™ã€‚
      </div>
    </div>

    <div class="footer">
      ğŸ’¡ æç¤ºï¼šé»æ“Šå³ä¸Šè§’ã€Œâš™ï¸ã€æŒ‰éˆ•å¯é€²è¡Œè³‡æ–™å‚™ä»½èˆ‡åŒ¯å…¥ã€‚<br>
      ç·¨è¼¯å‚™è¨»æ™‚å¯ç›´æ¥é¸æ“‡ã€ŒPBã€ã€ã€Œæ’ç‰†ã€ç­‰å¸¸ç”¨æ¨™ç±¤ã€‚
    </div>
  </div>

  <div id="startupModal" class="modal show">
    <div class="modal-content">
      <div class="modal-header">
        <h2>æ­¡è¿ä½¿ç”¨é•·è·‘ç´€éŒ„ç³»çµ±</h2>
      </div>
      <p style="margin-bottom:15px; color:#666;">
        è«‹é¸æ“‡è¼‰å…¥è³‡æ–™çš„æ–¹å¼ï¼š<br>
        (å»ºè­°ä¸‹è¼‰ä¸‹æ–¹ç¯„ä¾‹æª”é€²è¡Œæ¸¬è©¦)
      </p>
      
      <div style="background:#f1f3f5; padding:10px; border-radius:6px; margin-bottom:20px;">
        ğŸ“¥ <a href="./test_races.json" download style="color:#667eea; font-weight:bold; margin-right:15px; text-decoration:none;">ä¸‹è¼‰ JSON ç¯„ä¾‹</a>
        ğŸ“¥ <a href="./test_races.csv" download style="color:#667eea; font-weight:bold; text-decoration:none;">ä¸‹è¼‰ CSV ç¯„ä¾‹</a>
      </div>

      <div class="modal-buttons" style="justify-content:flex-start;">
        <button class="secondary" onclick="triggerImportJson()">åŒ¯å…¥ JSON</button>
        <button class="secondary" onclick="triggerImportCsv()">åŒ¯å…¥ CSV</button>
        <button class="success" onclick="startWithEmpty()">å¾ç©ºç™½é–‹å§‹</button>
      </div>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">ç·¨è¼¯æ¯”è³½è¨˜éŒ„</h2>
        <button class="close-btn" onclick="closeEditModal()">Ã—</button>
      </div>

      <input id="f_ç·¨è™Ÿ" type="hidden">

      <div class="form-grid">
        <div class="form-group">
          <label>ä¸­æ–‡åç¨±</label>
          <input id="f_ä¸­æ–‡åç¨±" type="text" list="list-cn-name">
          <datalist id="list-cn-name"></datalist>
        </div>
        <div class="form-group">
          <label>è‹±æ–‡åç¨±</label>
          <input id="f_è‹±æ–‡åç¨±" type="text" list="list-en-name">
          <datalist id="list-en-name"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>æ¯”è³½æ—¥æœŸ</label>
          <input id="f_æ¯”è³½æ—¥æœŸ" type="date">
        </div>
        <div class="form-group">
          <label>è·é›¢</label>
          <input id="f_è·é›¢" type="text" placeholder="å¦‚: 10 km, 21.095 km" list="list-distance">
          <datalist id="list-distance"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>åœ°é»</label>
          <input id="f_åœ°é»" type="text" list="list-location">
          <datalist id="list-location"></datalist>
        </div>
        <div class="form-group">
          <label>ä¸»è¾¦å–®ä½</label>
          <input id="f_ä¸»è¾¦å–®ä½" type="text" list="list-org">
          <datalist id="list-org"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>èµ·æ­¥æ™‚é–“</label>
          <input id="f_èµ·æ­¥æ™‚é–“" type="text" placeholder="06:00" list="list-start-time">
          <datalist id="list-start-time"></datalist>
        </div>
        <div class="form-group">
          <label>å®Œæˆæ™‚é–“ (hh:mm:ss)</label>
          <input id="f_å®Œæˆæ™‚é–“" type="text" placeholder="3:45:00" list="list-finish">
          <datalist id="list-finish"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>è³½äº‹çµ„åˆ¥</label>
          <input id="f_è³½äº‹çµ„åˆ¥" type="text" list="list-category">
          <datalist id="list-category"></datalist>
        </div>
        <div class="form-group">
          <label>è²»ç”¨</label>
          <input id="f_è²»ç”¨" type="text" list="list-fee">
          <datalist id="list-fee"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>åƒè³½è€…</label>
          <input id="f_åƒè³½è€…" type="text" list="runnerList">
          <datalist id="runnerList"></datalist>
        </div>
        <div class="form-group">
          <label>åƒè³½ç·¨è™Ÿ</label>
          <input id="f_åƒè³½ç·¨è™Ÿ" type="text" list="list-bib">
          <datalist id="list-bib"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>çµ„åˆ¥åæ¬¡</label>
          <input id="f_çµ„åˆ¥åæ¬¡" type="number" list="list-rank-group">
          <datalist id="list-rank-group"></datalist>
        </div>
        <div class="form-group">
          <label>ç¸½åæ¬¡</label>
          <input id="f_ç¸½åæ¬¡" type="number" list="list-rank-overall">
          <datalist id="list-rank-overall"></datalist>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>æº«åº¦(Â°C)</label>
          <input id="f_æº«åº¦" type="number" step="0.1" list="list-temp">
          <datalist id="list-temp"></datalist>
        </div>
        <div class="form-group">
          <label>å‚™è¨»</label>
          <input id="f_å‚™è¨»" type="text" list="list-note" placeholder="å¯é¸ï¼šPBã€ç†±èº«ä¸è¶³...">
          <datalist id="list-note">
            <option value="PB (å€‹äººæœ€ä½³)"></option>
            <option value="PW (å€‹äººæœ€å·®)"></option>
            <option value="ç†±èº«ä¸è¶³"></option>
            <option value="æ’ç‰†"></option>
            <option value="æŠ½ç­‹"></option>
            <option value="å¤©æ°£ç‚ç†±"></option>
            <option value="ä¸‹é›¨"></option>
            <option value="é †åˆ©å®Œè³½"></option>
            <option value="ç©ºç™½"></option>
          </datalist>
        </div>
      </div>

      <div class="modal-buttons">
        <button class="secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
        <button id="deleteBtn" class="delete-btn" onclick="deleteRace()">åˆªé™¤</button>
        <button class="success" onclick="saveRace()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // å®šç¾©å®Œæ•´æ¬„ä½æ¸…å–®
    const ALL_FIELDS = [
      "ç·¨è™Ÿ","ä¸­æ–‡åç¨±","è‹±æ–‡åç¨±","æ¯”è³½æ—¥æœŸ","è·é›¢","åœ°é»","è²»ç”¨",
      "ä¸»è¾¦å–®ä½","èµ·æ­¥æ™‚é–“","è³½äº‹çµ„åˆ¥","åƒè³½ç·¨è™Ÿ","åƒè³½è€…","æº«åº¦",
      "çµ„åˆ¥åæ¬¡","ç¸½åæ¬¡","å®Œæˆæ™‚é–“","å‚™è¨»"
    ];

    // å®šç¾©é¡¯ç¤ºæ¨¡å¼çš„æ¬„ä½é‚è¼¯
    // ç²¾ç°¡ï¼šç·¨è™Ÿ/æ—¥æœŸ/ä¸­æ–‡åç¨±/è·é›¢/æˆç¸¾/å‚™è¨»
    const COLUMNS_SIMPLE = ["ç·¨è™Ÿ", "æ¯”è³½æ—¥æœŸ", "ä¸­æ–‡åç¨±", "è·é›¢", "å®Œæˆæ™‚é–“", "å‚™è¨»"];
    
    // è©³ç´°ï¼šä¾æ­¤é †åºæ’åˆ—
    const COLUMNS_DETAIL = [
      "ç·¨è™Ÿ", "æ¯”è³½æ—¥æœŸ", "ä¸­æ–‡åç¨±", "è‹±æ–‡åç¨±", "åœ°é»", "ä¸»è¾¦å–®ä½", 
      "è·é›¢", "è³½äº‹çµ„åˆ¥", "èµ·æ­¥æ™‚é–“", 
      "åƒè³½è€…", "åƒè³½ç·¨è™Ÿ", 
      "å®Œæˆæ™‚é–“", "çµ„åˆ¥åæ¬¡", "ç¸½åæ¬¡", "æº«åº¦", "å‚™è¨»"
    ];

    let racesData = [];
    let filtered = [];
    let currentIndex = -1;
    
    // ç‹€æ…‹è®Šæ•¸
    let viewMode = 'simple'; // 'simple' or 'detail'
    let sortField = "æ¯”è³½æ—¥æœŸ";
    let sortDir = "desc";

    // é»æ“Šç©ºç™½è™•é—œé–‰è¨­å®šé¸å–®
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('settingsMenu');
      const btn = document.querySelector('.settings-btn');
      if (!menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.remove('show');
      }
    });

    function toggleSettings() {
      document.getElementById('settingsMenu').classList.toggle('show');
    }

    function setMode(mode) {
      viewMode = mode;
      document.getElementById('btnModeSimple').className = mode === 'simple' ? 'view-mode-btn active' : 'view-mode-btn';
      document.getElementById('btnModeDetail').className = mode === 'detail' ? 'view-mode-btn active' : 'view-mode-btn';
      renderHeaders();
      renderTable(filtered);
    }

    // å‹•æ…‹ç”Ÿæˆè¡¨é ­
    function renderHeaders() {
      const thead = document.getElementById('tableHead');
      const columns = viewMode === 'simple' ? COLUMNS_SIMPLE : COLUMNS_DETAIL;
      
      let html = '<tr>';
      columns.forEach(col => {
        let sortMark = 'â†•';
        if (sortField === col) sortMark = sortDir === 'asc' ? 'â†‘' : 'â†“';
        html += `<th class="sortable" onclick="changeSort('${col}')">${col}<span class="sort-indicator">${sortMark}</span></th>`;
      });
      html += '<th>æ“ä½œ</th></tr>';
      thead.innerHTML = html;
    }

    function changeSort(field) {
      if (sortField === field) {
        sortDir = (sortDir === "asc") ? "desc" : "asc";
      } else {
        sortField = field;
        sortDir = (field === "æ¯”è³½æ—¥æœŸ") ? "desc" : "asc";
      }
      renderHeaders(); // æ›´æ–°ç®­é ­
      applyFilters();  // é‡æ–°æ’åºä¸¦æ¸²æŸ“
    }

    // æ ¸å¿ƒè³‡æ–™æ›´æ–°
    function refreshData() {
      populateYears();
      refreshSuggestionLists();
      applyFilters();
    }

    function populateYears() {
      const yearSelect = document.getElementById('yearFilter');
      const currentVal = yearSelect.value;
      
      // æå–æ‰€æœ‰å¹´ä»½
      const years = new Set();
      racesData.forEach(r => {
        if (r["æ¯”è³½æ—¥æœŸ"] && r["æ¯”è³½æ—¥æœŸ"].length >= 4) {
          years.add(r["æ¯”è³½æ—¥æœŸ"].substring(0, 4));
        }
      });
      const sortedYears = Array.from(years).sort().reverse();

      let html = '<option value="">ğŸ“… å¹´ä»½(å…¨éƒ¨)</option>';
      sortedYears.forEach(y => {
        html += `<option value="${y}">${y}</option>`;
      });
      yearSelect.innerHTML = html;
      yearSelect.value = currentVal; // å˜—è©¦ä¿æŒé¸å–ç‹€æ…‹
    }

    // ç¯©é¸é‚è¼¯
    function applyFilters() {
      const q = document.getElementById("searchInput").value.toLowerCase();
      const distFilter = document.getElementById("distanceFilter").value;
      const runnerFilter = document.getElementById("runnerFilter").value;
      const yearFilter = document.getElementById("yearFilter").value;
      const monthFilter = document.getElementById("monthFilter").value;

      filtered = racesData.filter(function(r) {
        // æ–‡å­—æœå°‹
        const cn = (r["ä¸­æ–‡åç¨±"] || "").toLowerCase();
        const en = (r["è‹±æ–‡åç¨±"] || "").toLowerCase();
        const loc = (r["åœ°é»"] || "").toLowerCase();
        const bib = (r["åƒè³½ç·¨è™Ÿ"] || "").toLowerCase();
        const matchText = !q || cn.includes(q) || en.includes(q) || loc.includes(q) || bib.includes(q);

        // è·é›¢ç¯©é¸
        const distStr = r["è·é›¢"] || "";
        let matchDistance = true;
        if (distFilter === "OTHER") {
          matchDistance = !distStr || (!distStr.includes("10") && !distStr.includes("21") && !distStr.includes("42"));
        } else if (distFilter) {
          matchDistance = distStr.includes(distFilter);
        }

        // åƒè³½è€…ç¯©é¸
        const matchRunner = !runnerFilter || (r["åƒè³½è€…"] || "").trim() === runnerFilter;

        // å¹´ä»½ç¯©é¸
        const rDate = r["æ¯”è³½æ—¥æœŸ"] || "";
        const rYear = rDate.substring(0, 4);
        const matchYear = !yearFilter || rYear === yearFilter;

        // æœˆä»½ç¯©é¸
        // æ—¥æœŸæ ¼å¼é€šå¸¸ç‚º YYYY-MM-DD
        let matchMonth = true;
        if (monthFilter) {
          const parts = rDate.split("-");
          if (parts.length >= 2) {
            matchMonth = parts[1] === monthFilter;
          } else {
            matchMonth = false;
          }
        }

        return matchText && matchDistance && matchRunner && matchYear && matchMonth;
      });

      // æ’åº
      filtered.sort(function(a, b) {
        let v1 = a[sortField];
        let v2 = b[sortField];
        if (v1 == null) v1 = "";
        if (v2 == null) v2 = "";

        let cmp = 0;
        if (sortField === "æ¯”è³½æ—¥æœŸ") {
           cmp = (!v1 && !v2) ? 0 : (!v1 ? 1 : (!v2 ? -1 : v1.localeCompare(v2)));
        } else if (["ç·¨è™Ÿ", "æº«åº¦", "çµ„åˆ¥åæ¬¡", "ç¸½åæ¬¡"].includes(sortField)) {
          cmp = (parseFloat(v1)||0) - (parseFloat(v2)||0);
        } else {
          cmp = String(v1).localeCompare(String(v2), "zh-Hant");
        }
        return sortDir === "desc" ? -cmp : cmp;
      });

      renderTable(filtered);
    }

    function createCell(content, isEmpty, classes = "") {
      const cls = (isEmpty ? "empty-cell " : "") + classes;
      return `<td class="${cls}">${content}</td>`;
    }

    function renderTable(list) {
      const tbody = document.getElementById("tableBody");
      const noRes = document.getElementById("noResults");
      
      if (!list.length) {
        tbody.innerHTML = "";
        noRes.style.display = "block";
        return;
      }
      noRes.style.display = "none";

      const columns = viewMode === 'simple' ? COLUMNS_SIMPLE : COLUMNS_DETAIL;

      const rowsHtml = list.map(function(r) {
        let rowHtml = '<tr>';
        
        columns.forEach(col => {
          const val = r[col] || "";
          let displayVal = val;
          let extraClass = "";

          // ç‰¹æ®Šæ¬„ä½è™•ç†
          if (col === "è·é›¢" && val) {
            displayVal = `<span class="distance-tag">${val}</span>`;
          }
          else if (col === "æ¯”è³½æ—¥æœŸ") {
            extraClass = "date-cell";
          }
          else if (col === "å‚™è¨»") {
            extraClass = "note-cell";
            // if (val) displayVal = `<span title="${val}">${val}</span>`;
          }

          rowHtml += createCell(displayVal, !val, extraClass);
        });

        const id = r["ç·¨è™Ÿ"];
        rowHtml += `<td><button class="action-btn" onclick="openEditModal(${id})">ç·¨è¼¯</button></td>`;
        rowHtml += '</tr>';
        return rowHtml;
      }).join("");

      tbody.innerHTML = rowsHtml;
    }

    function resetFilters() {
      document.getElementById("searchInput").value = "";
      document.getElementById("runnerFilter").value = "";
      document.getElementById("distanceFilter").value = "";
      document.getElementById("yearFilter").value = "";
      document.getElementById("monthFilter").value = "";
      applyFilters();
    }

    // Modal & CRUD Operations
    function openEditModal(id) {
      currentIndex = racesData.findIndex(r => r["ç·¨è™Ÿ"] === id);
      const r = currentIndex === -1 ? {} : racesData[currentIndex];
      const isEdit = currentIndex !== -1;

      document.getElementById("modalTitle").textContent = isEdit ? "ç·¨è¼¯æ¯”è³½è¨˜éŒ„" : "æ–°å¢æ¯”è³½è¨˜éŒ„";
      document.getElementById("deleteBtn").style.display = isEdit ? "inline-block" : "none";
      
      // Auto-fill ID
      if (!isEdit) {
        const maxId = racesData.length ? Math.max(...racesData.map(d => Number(d["ç·¨è™Ÿ"])||0)) : 0;
        document.getElementById("f_ç·¨è™Ÿ").value = maxId + 1;
      } else {
        document.getElementById("f_ç·¨è™Ÿ").value = r["ç·¨è™Ÿ"];
      }

      // Fill inputs
      ALL_FIELDS.forEach(k => {
        if (k === "ç·¨è™Ÿ") return;
        const el = document.getElementById("f_" + k);
        if (el) el.value = r[k] || "";
      });

      refreshSuggestionLists();
      document.getElementById("editModal").classList.add("show");
    }

    function openAddModal() {
      openEditModal(-1); // ID -1 means new
    }

    function closeEditModal() {
      document.getElementById("editModal").classList.remove("show");
    }

    function saveRace() {
      const rec = {};
      // Get ID
      rec["ç·¨è™Ÿ"] = parseInt(document.getElementById("f_ç·¨è™Ÿ").value, 10);
      
      // Get other fields
      ALL_FIELDS.forEach(k => {
        if (k === "ç·¨è™Ÿ") return;
        const el = document.getElementById("f_" + k);
        if (el) rec[k] = el.value.trim();
      });

      if (!rec["ä¸­æ–‡åç¨±"] && !rec["è‹±æ–‡åç¨±"]) {
        alert("è«‹è‡³å°‘è¼¸å…¥ä¸­æ–‡æˆ–è‹±æ–‡åç¨±ã€‚");
        return;
      }

      if (currentIndex === -1) {
        racesData.push(rec);
      } else {
        racesData[currentIndex] = rec;
      }

      refreshData();
      closeEditModal();
    }

    function deleteRace() {
      if (currentIndex === -1) return;
      if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤æ¯”è³½è¨˜éŒ„å—ï¼Ÿ")) return;
      racesData.splice(currentIndex, 1);
      refreshData();
      closeEditModal();
    }

    // Datalist population
    function refreshSuggestionLists() {
      const runnerSelect = document.getElementById("runnerFilter");
      const currentRunner = runnerSelect.value;
      
      // Update Runner Dropdown
      const runners = Array.from(new Set(racesData.map(r => (r["åƒè³½è€…"]||"").trim()).filter(Boolean))).sort();
      let runnerHtml = '<option value="">ğŸ‘¤ åƒè³½è€…(å…¨éƒ¨)</option>';
      runners.forEach(rn => {
        runnerHtml += `<option value="${rn}">${rn}</option>`;
      });
      runnerSelect.innerHTML = runnerHtml;
      if (runners.includes(currentRunner)) runnerSelect.value = currentRunner;

      // Update other datalists
      const fieldsToUpdate = ["ä¸­æ–‡åç¨±", "è‹±æ–‡åç¨±", "è·é›¢", "åœ°é»", "è²»ç”¨", "ä¸»è¾¦å–®ä½", "èµ·æ­¥æ™‚é–“", "è³½äº‹çµ„åˆ¥", "åƒè³½ç·¨è™Ÿ", "åƒè³½è€…", "æº«åº¦", "çµ„åˆ¥åæ¬¡", "ç¸½åæ¬¡", "å®Œæˆæ™‚é–“"];
      
      fieldsToUpdate.forEach(field => {
        const listId = "list-" + getFieldShortName(field);
        const dl = document.getElementById(listId);
        if (dl) {
          const vals = Array.from(new Set(racesData.map(r => (r[field]||"").trim()).filter(Boolean))).sort();
          // Keep existing options for "Note" field, append user data? 
          // For simplicity, we just rebuild mostly, but Note has static options in HTML
          if (field !== "å‚™è¨»") { 
             dl.innerHTML = vals.map(v => `<option value="${v.replace(/"/g, "&quot;")}"></option>`).join("");
          }
        }
      });
    }

    function getFieldShortName(name) {
      const map = {
        "ä¸­æ–‡åç¨±":"cn-name", "è‹±æ–‡åç¨±":"en-name", "è·é›¢":"distance", "åœ°é»":"location",
        "è²»ç”¨":"fee", "ä¸»è¾¦å–®ä½":"org", "èµ·æ­¥æ™‚é–“":"start-time", "è³½äº‹çµ„åˆ¥":"category",
        "åƒè³½ç·¨è™Ÿ":"bib", "åƒè³½è€…":"runnerList", // special case in HTML
        "æº«åº¦":"temp", "çµ„åˆ¥åæ¬¡":"rank-group", "ç¸½åæ¬¡":"rank-overall", 
        "å®Œæˆæ™‚é–“":"finish", "å‚™è¨»":"note"
      };
      // Handle special runnerList mapping logic or standard logic
      if (name === "åƒè³½è€…") return "runnerList"; // Datalist ID matches HTML
      return map[name] || "";
    }


    // File I/O
    function triggerImportJson() { document.getElementById("importJsonFile").click(); toggleSettings(); }
    function triggerImportCsv() { document.getElementById("importCsvFile").click(); toggleSettings(); }
    
    function downloadJSON() {
       toggleSettings(); // Close menu
       if (!racesData.length) { alert("ç„¡è³‡æ–™"); return; }
       const blob = new Blob([JSON.stringify(racesData, null, 2)], {type: "application/json"});
       const a = document.createElement("a");
       a.href = URL.createObjectURL(blob);
       a.download = "Running-Data-" + new Date().toISOString().slice(0,10) + ".json";
       a.click();
    }

    function downloadCSV() {
      toggleSettings();
      if (!racesData.length) { alert("ç„¡è³‡æ–™"); return; }
      const headers = ALL_FIELDS.join(",");
      const rows = racesData.map(r => ALL_FIELDS.map(k => {
        const v = String(r[k]||"").replace(/"/g, '""');
        return `"${v}"`;
      }).join(",")).join("\r\n");
      const blob = new Blob([headers + "\r\n" + rows], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "Running-Data.csv";
      a.click();
    }

    function importJSON(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            // Merge logic or overwrite? Current logic: Overwrite
            racesData = data;
            refreshData();
            document.getElementById("startupModal").classList.remove("show");
            alert("åŒ¯å…¥æˆåŠŸ");
          }
        } catch(err) { alert("JSON æ ¼å¼éŒ¯èª¤"); }
      };
      reader.readAsText(file);
    }

    function importCsvParsers(text) {
       // Simple CSV parser supporting quotes
       const arr = [];
       let quote = false;  // 'true' means we're inside a quoted field
       let col = 0, row = 0;
       let c = "";
       for (let i = 0; i < text.length; i++) {
           const cc = text[i];
           const nc = text[i+1];
           arr[row] = arr[row] || [];
           arr[row][col] = arr[row][col] || "";

           if (cc === '"' && quote && nc === '"') { arr[row][col] += '"'; ++i; continue; }
           if (cc === '"') { quote = !quote; continue; }
           if (cc === ',' && !quote) { ++col; continue; }
           if (cc === '\r' && !quote && nc === '\n') { ++row; col = 0; ++i; continue; }
           if (cc === '\n' && !quote) { ++row; col = 0; continue; }
           if (cc === '\r' && !quote) { ++row; col = 0; continue; }
           arr[row][col] += cc;
       }
       return arr;
    }

    function importCSV(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const rows = importCsvParsers(e.target.result);
          const headers = rows[0].map(h => h.trim());
          const newDat = [];
          for(let i=1; i<rows.length; i++) {
            if (rows[i].length < 2) continue;
            let obj = {};
            ALL_FIELDS.forEach(f => obj[f] = ""); // init
            rows[i].forEach((val, idx) => {
              if (headers[idx]) obj[headers[idx]] = val;
            });
            // Ensure ID
            obj["ç·¨è™Ÿ"] = Number(obj["ç·¨è™Ÿ"]) || (i);
            newDat.push(obj);
          }
          racesData = newDat;
          refreshData();
          document.getElementById("startupModal").classList.remove("show");
          alert("CSV åŒ¯å…¥æˆåŠŸ");
        } catch(err) { console.error(err); alert("CSV è§£æéŒ¯èª¤"); }
      };
      reader.readAsText(file);
    }
    
    function startWithEmpty() {
      racesData = [];
      refreshData();
      document.getElementById("startupModal").classList.remove("show");
    }

    // Init
    renderHeaders();
    refreshData();

  </script>
</body>
</html>
